<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Axon OS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Variáveis e Reset */
        :root {
            --primary: #0c0c1d;
            --secondary: #1a1a3a;
            --accent: #6a5af9;
            --accent-light: #7d6dfa;
            --text: #e6e6ff;
            --text-secondary: #a0a0c0;
            --success: #00cc88;
            --warning: #ffaa00;
            --danger: #ff5577;
            --card-bg: rgba(30, 30, 50, 0.7);
            --glass: rgba(40, 40, 60, 0.3);
            --terminal-green: #00ff9f;
            --terminal-purple: #bd93f9;
            --highlight: rgba(106, 90, 249, 0.2);
            --border-radius: 14px;
            --menu-bar-height: 30px;
            --dock-height: 70px;
            --maximized-margin-top: 40px;
            --maximized-margin-bottom: 80px;
            --maximized-margin-left: 20px;
            --maximized-margin-right: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            user-select: none;
        }

        body {
            background: radial-gradient(circle at center, var(--primary), var(--secondary));
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        #particles {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        #menu-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 15px;
            background: rgba(10, 10, 25, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            height: var(--menu-bar-height);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .menu-section {
            display: flex;
            gap: 20px;
        }

        .menu-item {
            font-size: 13px;
            cursor: pointer;
            padding: 3px 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .menu-item:hover {
            background: var(--highlight);
        }

        .status-icons {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        #ai-api-badge {
            background-color: var(--accent);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            display: none; /* Hidden by default */
            margin-right: 10px;
        }

        #desktop {
            position: absolute;
            top: var(--menu-bar-height);
            bottom: var(--dock-height);
            left: 0;
            right: 0;
            overflow: hidden;
            padding: 20px;
        }

        .desktop-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
            height: 90px;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            transition: all 0.2s ease;
            position: absolute;
            text-align: center;
            justify-content: center;
        }

        .desktop-icon:hover {
            background: var(--highlight);
        }

        .desktop-icon.selected {
            background: var(--highlight);
            outline: 1px solid var(--accent);
        }

        .icon-image {
            width: 50px;
            height: 50px;
            background: var(--glass);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 5px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .icon-label {
            font-size: 12px;
            text-align: center;
            word-break: break-word;
            line-height: 1.3;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #dock {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 8px;
            z-index: 999;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease-out;
        }

        #dock.hidden {
            transform: translateX(-50%) translateY(calc(var(--dock-height) + 20px));
        }

        .dock-icon {
            width: 50px;
            height: 50px;
            margin: 0 5px;
            background: var(--card-bg);
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .dock-icon:hover {
            transform: translateY(-15px) scale(1.2);
            background: var(--accent);
        }

        .dock-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
        }

        .divider {
            width: 1px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            margin: 5px 10px;
        }

        .window {
            position: absolute;
            width: 800px;
            height: 500px;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            z-index: 100;
            border: 1px solid rgba(255, 255, 255, 0.1);
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.3s ease, transform 0.3s ease, width 0.3s ease, height 0.3s ease, left 0.3s ease, top 0.3s ease;
            resize: both;
            min-width: 300px;
            min-height: 200px;
        }

        .window.active {
            opacity: 1;
            transform: scale(1);
        }

        .window.maximized {
            top: var(--maximized-margin-top) !important;
            left: var(--maximized-margin-left) !important;
            width: calc(100% - var(--maximized-margin-left) - var(--maximized-margin-right)) !important;
            height: calc(100vh - var(--maximized-margin-top) - var(--maximized-margin-bottom)) !important;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
        }

        .window-header {
            height: 40px;
            background: rgba(20, 20, 40, 0.8);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            cursor: grab;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .window-title {
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-grow: 1;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            padding-left: 5px;
        }

        .window-controls {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .window-control {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .window-control:hover {
            opacity: 1;
        }

        .window-close { background: var(--danger); }
        .window-minimize { background: var(--warning); }
        .window-maximize { background: var(--success); }

        .window-content {
            flex: 1;
            padding: 15px;
            overflow: auto;
        }

        .tab-container {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 15px;
        }

        .tab {
            padding: 10px 15px;
            cursor: pointer;
            font-size: 14px;
            opacity: 0.7;
            transition: all 0.2s ease;
        }

        .tab.active {
            opacity: 1;
            border-bottom: 2px solid var(--accent);
        }

        .tab:hover {
            opacity: 1;
        }

        input, textarea, select {
            background: rgba(30, 30, 50, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px 15px;
            color: var(--text);
            font-size: 14px;
            outline: none;
            transition: all 0.2s ease;
        }

        input:focus, textarea:focus, select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--highlight);
        }

        button {
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text);
            padding: 10px 15px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        button:hover {
            background: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .file-explorer {
            display: flex;
            height: 100%;
            flex-direction: column;
        }

        .finder-toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(20, 20, 40, 0.5);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .finder-toolbar .path-display {
            flex-grow: 1;
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .finder-main-area {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 200px;
            background: rgba(20, 20, 40, 0.5);
            padding: 15px 0;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            overflow-y: auto;
        }

        .sidebar-item {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s ease;
        }

        .sidebar-item:hover {
            background: var(--highlight);
        }

        .sidebar-item.active {
            background: var(--highlight);
            border-left: 3px solid var(--accent);
            padding-left: 12px;
        }

        .main-content {
            flex: 1;
            padding: 15px;
            overflow: auto;
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }

        .file-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
            position: relative;
        }

        .file-item:hover {
            background: var(--highlight);
        }

        .file-item.selected {
            background: var(--highlight);
            outline: 1px solid var(--accent);
        }

        .file-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .notepad-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .notepad-toolbar {
            display: flex;
            gap: 10px;
            padding-bottom: 10px;
        }

        .notepad-toolbar button {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .notepad-content {
            flex: 1;
        }

        .notepad-content textarea {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            resize: none;
            font-family: 'SF Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .assistant-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.4;
        }

        .user-message {
            background: var(--accent);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .assistant-message {
            background: rgba(40, 40, 60, 0.5);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .chat-input {
            display: flex;
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
        }

        .terminal-container {
            background: rgba(10, 10, 20, 0.9);
            height: 100%;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            font-family: 'SF Mono', monospace;
            font-size: 14px;
        }

        .terminal-header {
            padding: 10px 15px;
            background: rgba(20, 20, 40, 0.8);
            display: flex;
            justify-content: space-between;
        }

        .terminal-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            line-height: 1.5;
        }

        .terminal-input {
            display: flex;
            padding: 10px 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            align-items: center;
            gap: 10px;
        }

        .prompt {
            color: var(--terminal-green);
        }

        .terminal-content .command {
            color: var(--terminal-purple);
        }

        .gallery-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            padding: 15px;
        }

        .gallery-item {
            height: 180px;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .gallery-item:hover img {
            transform: scale(1.05);
        }

        .gallery-item:hover .gallery-options {
            display: flex;
        }

        .gallery-options {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            gap: 10px;
            padding: 5px;
        }

        .gallery-option-btn {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }

        .media-player {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 20px;
            align-items: center;
            justify-content: center;
        }

        .album-art {
            width: 300px;
            height: 300px;
            border-radius: 10px;
            background: linear-gradient(45deg, #6a5af9, #d66efd);
            margin-bottom: 30px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .track-info {
            text-align: center;
            margin-bottom: 30px;
        }

        .track-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .track-artist {
            font-size: 16px;
            opacity: 0.8;
        }

        .player-controls {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .player-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .player-btn.play-btn {
            width: 70px;
            height: 70px;
            font-size: 24px;
        }

        .player-btn:hover {
            background: var(--accent-light);
            transform: scale(1.1);
        }

        .progress-container {
            width: 100%;
            max-width: 500px;
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
        }

        .progress {
            height: 100%;
            background: var(--accent);
            width: 30%;
            border-radius: 10px;
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 12px;
            opacity: 0.7;
        }

        .context-menu {
            position: absolute;
            background: rgba(30, 30, 50, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 8px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
            min-width: 180px;
        }

        .context-menu-item {
            padding: 8px 20px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s ease;
        }

        .context-menu-item:hover {
            background: var(--highlight);
        }

        .context-menu-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 5px 0;
        }

        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .custom-modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .custom-modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            width: 350px;
            max-width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .custom-modal.active .custom-modal-content {
            transform: translateY(0);
        }

        .custom-modal-header {
            padding: 15px 20px;
            background: rgba(20, 20, 40, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-weight: 500;
        }

        .custom-modal-body {
            padding: 20px;
            line-height: 1.5;
        }

        .custom-modal-body input {
            width: 100%;
            margin-top: 10px;
        }

        .custom-modal-footer {
            padding: 15px 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            width: 400px;
            max-width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            overflow: hidden;
        }

        .modal-header {
            padding: 15px 20px;
            background: rgba(20, 20, 40, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 {
            flex-grow: 1;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glow {
            text-shadow: 0 0 10px var(--accent);
        }

        .neon-border {
            box-shadow: 0 0 10px var(--accent);
        }

        .grid-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 20px 20px;
            z-index: -1;
        }

        .browser-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .browser-toolbar {
            display: flex;
            padding: 10px;
            gap: 10px;
            background: rgba(20, 20, 40, 0.5);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .browser-url-bar {
            flex: 1;
            display: flex;
        }

        .browser-content {
            flex: 1;
            border: none;
            width: 100%;
            height: 100%;
        }

        .camera-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .camera-preview {
            width: 80%;
            height: 70%;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .camera-preview video, .camera-preview canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        .image-viewer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: rgba(0,0,0,0.8);
        }
        .image-viewer-content .image-path {
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90%;
        }
        .image-viewer-content img {
            max-width: 90%;
            max-height: calc(100% - 30px);
            object-fit: contain;
        }

        #window-carousel-modal .modal-content {
            width: 90%;
            max-width: 1000px;
            height: 80%;
            display: flex;
            flex-direction: column;
        }

        #window-carousel-modal .modal-body {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            align-content: flex-start;
            overflow-y: auto;
        }

        .window-thumbnail {
            width: 200px;
            height: 150px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            position: relative;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s ease;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .window-thumbnail:hover {
            transform: translateY(-5px);
        }

        .window-thumbnail-header {
            background: rgba(20, 20, 40, 0.8);
            padding: 5px 10px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
        }

        .window-thumbnail-header .window-title-text {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 25px;
        }

        .window-thumbnail-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            opacity: 0.5;
        }

        .window-thumbnail .close-btn {
            position: absolute;
            top: 50%;
            right: 5px;
            transform: translateY(-50%);
            background: var(--danger);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s ease;
            flex-shrink: 0;
        }

        .window-thumbnail .close-btn:hover {
            opacity: 1;
        }

        #help-guide-modal .modal-content {
            width: 600px;
            max-width: 90%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        #help-guide-modal .modal-body {
            flex: 1;
            overflow-y: auto;
        }
        #help-guide-modal .modal-body h4 {
            margin-top: 15px;
            margin-bottom: 5px;
            color: var(--accent-light);
        }
        #help-guide-modal .modal-body ul {
            list-style-type: disc;
            margin-left: 20px;
        }
        #help-guide-modal .modal-body li {
            margin-bottom: 5px;
        }

        .settings-tab-content {
            display: none;
            padding: 20px;
        }
        .settings-tab-content.active {
            display: block;
        }
        .settings-section {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .settings-section h4 {
            margin-bottom: 15px;
            color: var(--accent-light);
        }
        .settings-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        .settings-option label {
            flex: 1;
        }
        .settings-option input[type="checkbox"] {
            width: auto;
            padding: 0;
            margin-right: 5px;
        }
        .wallpaper-option {
            width: 100px;
            height: 60px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s ease;
        }
        .wallpaper-option.selected {
            border-color: var(--accent);
        }

        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            flex-direction: column;
            gap: 20px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        #login-screen.active {
            opacity: 1;
            pointer-events: all;
        }

        .login-box {
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            width: 350px;
            max-width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .login-box h2 {
            margin-bottom: 25px;
            color: var(--text);
            font-size: 28px;
        }

        .login-box input {
            width: calc(100% - 20px);
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
        }

        .login-box button {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .login-box button:hover {
            background: var(--accent-light);
        }

        .axon-apps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            padding: 15px;
            height: 100%;
            overflow-y: auto;
            align-content: flex-start;
        }

        .axon-app-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 120px;
            cursor: pointer;
            padding: 10px 5px;
            border-radius: 8px;
            transition: all 0.2s ease;
            height: 120px;
            justify-content: center;
        }

        .axon-app-item:hover {
            background: var(--highlight);
        }

        .axon-app-item .icon-image {
            width: 70px;
            height: 70px;
            font-size: 36px;
            margin-bottom: 8px;
        }

        .axon-app-item .icon-label {
            font-size: 12px;
            margin-top: 5px;
            text-align: center;
            word-break: break-word;
            line-height: 1.2;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, var(--primary), var(--secondary));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 6000;
            color: var(--text);
            font-size: 24px;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }

        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            border: 3px solid transparent;
            background-clip: padding-box;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .create-item-button {
            padding: 8px 12px;
            font-size: 14px;
            gap: 3px;
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="spinner"></div>
        <p>Iniciando Axon OS...</p>
    </div>

    <canvas id="particles"></canvas>
    <div class="grid-bg"></div>

    <div id="menu-bar">
        <div class="menu-section">
            <div class="menu-item" id="axon-menu">Axon OS</div>
            <div class="menu-item" id="window-carousel-btn">Janela</div>
            <div class="menu-item" id="help-guide-btn">Ajuda</div>
        </div>
        <div class="status-icons">
            <span id="ai-api-badge">A.I API</span>
            <div id="clock">14:25</div>
        </div>
    </div>

    <div id="desktop"></div>

    <div id="dock">
        <div class="dock-icon" data-app="finder" data-tooltip="Explorador de Arquivos"><i class="fas fa-folder"></i></div>
        <div class="dock-icon" data-app="notes" data-tooltip="Bloco de Notas"><i class="fas fa-edit"></i></div>
        <div class="dock-icon" data-app="terminal" data-tooltip="Terminal"><i class="fas fa-terminal"></i></div>
        <div class="dock-icon" data-app="calculator" data-tooltip="Calculadora"><i class="fas fa-calculator"></i></div>
        <div class="dock-icon" data-app="camera" data-tooltip="Câmera"><i class="fas fa-camera"></i></div>
        <div class="dock-icon" data-app="gallery" data-tooltip="Galeria de Imagens"><i class="fas fa-images"></i></div>
        <div class="dock-icon" data-app="axon-apps" data-tooltip="Axon Apps"><i class="fas fa-th-large"></i></div>
        <div class="dock-icon" data-app="browser" data-tooltip="Navegador Web"><i class="fas fa-globe"></i></div>
        <div class="divider"></div>
        <div class="dock-icon" data-app="settings" data-tooltip="Configurações"><i class="fas fa-cog"></i></div>
        <div class="dock-icon" data-app="mielina" data-tooltip="Assistente Virtual"><i class="fas fa-robot"></i></div>
    </div>

    <div id="windows-container"></div>

    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" id="context-open"><i class="fas fa-folder-open"></i> Abrir</div>
        <div class="context-menu-item" id="context-rename"><i class="fas fa-edit"></i> Renomear</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="context-cut"><i class="fas fa-cut"></i> Recortar</div>
        <div class="context-menu-item" id="context-copy"><i class="fas fa-copy"></i> Copiar</div>
        <div class="context-menu-item" id="context-paste"><i class="fas fa-paste"></i> Colar</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="context-new-folder"><i class="fas fa-folder-plus"></i> Nova Pasta</div>
        <div class="context-menu-item" id="context-new-file"><i class="fas fa-file"></i> Novo Arquivo</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="context-delete"><i class="fas fa-trash"></i> Excluir</div>
        <div class="context-menu-item" id="context-restore" style="display: none;"><i class="fas fa-undo"></i> Restaurar</div>
        <div class="context-menu-item" id="context-delete-permanent" style="display: none;"><i class="fas fa-times-circle"></i> Excluir Permanentemente</div>
    </div>

    <div class="modal" id="create-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Criar Novo Item</h3>
                <div class="window-controls">
                    <div class="window-control window-close" onclick="closeModal('create-modal')"><i class="fas fa-times"></i></div>
                </div>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <label>Tipo:</label>
                    <select id="item-type" style="width: 100%; margin-top: 5px;">
                        <option value="folder">Pasta</option>
                        <option value="text">Documento de Texto</option>
                        <option value="image">Imagem</option>
                        <option value="link">Link</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label>Nome:</label>
                    <input type="text" id="item-name" placeholder="Nome do item" style="width: 100%; margin-top: 5px;">
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-create">Cancelar</button>
                <button id="confirm-create">Criar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="open-file-modal">
        <div class="modal-content" style="width: 600px; height: 500px;">
            <div class="modal-header">
                <h3>Abrir Arquivo</h3>
                <div class="window-controls">
                    <div class="window-control window-close" onclick="closeModal('open-file-modal')"><i class="fas fa-times"></i></div>
                </div>
            </div>
            <div class="modal-body" style="height: calc(100% - 100px); overflow: hidden; display: flex; flex-direction: column;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="file-search" placeholder="Pesquisar..." style="flex: 1;">
                    <button><i class="fas fa-search"></i></button>
                </div>
                <div style="flex: 1; overflow: auto; background: rgba(0,0,0,0.1); border-radius: 8px; padding: 10px;">
                    <div id="file-list"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-open-file">Cancelar</button>
                <button id="confirm-open-file">Abrir</button>
            </div>
        </div>
    </div>

    <div class="custom-modal" id="custom-alert-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header" id="custom-alert-header"></div>
            <div class="custom-modal-body" id="custom-alert-body"></div>
            <div class="custom-modal-footer" id="custom-alert-footer"></div>
        </div>
    </div>

    <div class="modal" id="image-viewer-modal">
        <div class="modal-content" style="width: 80%; height: 80%;">
            <div class="modal-header">
                <h3 id="image-viewer-title">Visualizador de Imagens</h3>
                <div class="window-controls">
                    <div class="window-control window-close" onclick="closeModal('image-viewer-modal')"><i class="fas fa-times"></i></div>
                </div>
            </div>
            <div class="modal-body image-viewer-content">
                <div class="image-path" id="image-viewer-path"></div>
                <img id="image-viewer-img" src="" alt="Imagem">
            </div>
        </div>
    </div>

    <div class="modal" id="window-carousel-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Janelas Abertas</h3>
            </div>
            <div class="modal-body" id="window-carousel-body"></div>
            <div class="modal-footer">
                <button id="close-all-windows-btn">Fechar Todas as Janelas</button>
                <button onclick="closeModal('window-carousel-modal')">Fechar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="help-guide-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Guia de Acesso ao Sistema Axon OS</h3>
                <div class="window-controls">
                    <div class="window-control window-close" onclick="closeModal('help-guide-modal')"><i class="fas fa-times"></i></div>
                </div>
            </div>
            <div class="modal-body">
                <p>Bem-vindo ao Axon OS! Este guia rápido irá ajudá-lo a começar.</p>
                
                <div class="settings-section">
                    <h4><i class="fas fa-mouse-pointer"></i> Interação Básica</h4>
                    <ul>
                        <li><strong>Clique Simples:</strong> Seleciona um item.</li>
                        <li><strong>Clique Duplo:</strong> Abre um aplicativo ou item.</li>
                        <li><strong>Botão Direito (Menu de Contexto):</b> Abre opções para o item selecionado ou para a área de trabalho.</li>
                        <li><strong>Arrastar e Soltar:</strong> Mova ícones na área de trabalho.</li>
                    </ul>
                </div>

                <div class="settings-section">
                    <h4><i class="fas fa-rocket"></i> Aplicativos Essenciais</h4>
                    <ul>
                        <li><strong>Explorador de Arquivos (<i class="fas fa-folder"></i>):</strong> Gerencie seus arquivos e pastas.</li>
                        <li><strong>Bloco de Notas (<i class="fas fa-edit"></i>):</strong> Crie e edite documentos de texto.</li>
                        <li><strong>Terminal (<i class="fas fa-terminal"></i>):</strong> Para usuários avançados, execute comandos do sistema.</li>
                        <li><strong>Mielina (<i class="fas fa-robot"></i>):</strong> Sua assistente virtual para ajuda rápida.</li>
                        <li><strong>Configurações (<i class="fas fa-cog"></i>):</strong> Personalize o sistema e gerencie opções.</li>
                    </ul>
                </div>

                <div class="settings-section">
                    <h4><i class="fas fa-window-restore"></i> Gerenciamento de Janelas</h4>
                    <ul>
                        <li><strong>Minimizar (<i class="fas fa-minus"></i>):</strong> Oculta a janela na barra de tarefas.</li>
                        <li><strong>Maximizar/Restaurar (<i class="fas fa-square"></i>):</strong> Alterna entre tela cheia e tamanho original.</li>
                        <li><strong>Fechar (<i class="fas fa-times"></i>):</strong> Encerra o aplicativo.</li>
                        <li><strong>Menu "Janela":</strong> Visualize e gerencie todas as janelas abertas.</li>
                    </ul>
                </div>

                <p>Explore o Axon OS e descubra todas as suas funcionalidades!</p>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('help-guide-modal')">Entendi</button>
            </div>
        </div>
    </div>

    <div id="login-screen">
        <div class="login-box">
            <h2>Axon OS</h2>
            <input type="text" id="login-username" placeholder="Usuário">
            <input type="password" id="login-password" placeholder="Senha">
            <button id="login-button">Entrar</button>
        </div>
    </div>

    <script>
        // Dados iniciais do sistema
        const systemData = {
            apps: {
                finder: { name: "Explorador de Arquivos", icon: "fas fa-folder", minWidth: 700, minHeight: 500 },
                notes: { name: "Bloco de Notas", icon: "fas fa-edit", minWidth: 600, minHeight: 500 },
                terminal: { name: "Terminal", icon: "fas fa-terminal", minWidth: 700, minHeight: 500 },
                calculator: { name: "Calculadora", icon: "fas fa-calculator", minWidth: 300, minHeight: 400 },
                camera: { name: "Câmera", icon: "fas fa-camera", minWidth: 500, minHeight: 400 },
                gallery: { name: "Galeria de Imagens", icon: "fas fa-images", minWidth: 800, minHeight: 500 },
                'axon-apps': { name: "Axon Apps", icon: "fas fa-th-large", minWidth: 600, minHeight: 500 },
                browser: { name: "Navegador Axon", icon: "fas fa-globe", minWidth: 900, minHeight: 600 },
                settings: { name: "Configurações", icon: "fas fa-cog", minWidth: 700, minHeight: 500 },
                mielina: { name: "Mielina - Assistente Virtual", icon: "fas fa-robot", minWidth: 500, minHeight: 500 }
            },
            desktopItems: [],
            fileSystem: {
                'axon': { id: 'axon', name: 'Axon', type: 'folder', icon: 'fas fa-hdd', path: 'axon', children: [] },
                'axon/desktop': { id: 'axon/desktop', name: 'Área de Trabalho', type: 'folder', icon: 'fas fa-desktop', path: 'axon/desktop', children: [] },
                'axon/documents': { id: 'axon/documents', name: 'Documentos', type: 'folder', icon: 'fas fa-folder', path: 'axon/documents', children: [
                    { id: 'axon/documents/Relatório Final.txt', name: 'Relatório Final.txt', type: 'text', icon: 'fas fa-file-alt', content: 'Conteúdo do relatório final do projeto Axon OS. Este é um documento de exemplo.', parentId: 'axon/documents' },
                    { id: 'axon/documents/Anotações.txt', name: 'Anotações.txt', type: 'text', icon: 'fas fa-file-alt', content: 'Minhas anotações importantes:\n- Comprar leite\n- Ligar para o suporte\n- Estudar JavaScript', parentId: 'axon/documents' }
                ]},
                'axon/images': { id: 'axon/images', name: 'Imagens', type: 'folder', icon: 'fas fa-image', path: 'axon/images', children: [
                    { id: 'axon/images/Paisagem.jpg', name: 'Paisagem.jpg', type: 'image', icon: 'fas fa-image', src: 'https://images.unsplash.com/photo-1506744038136-465a60a35c88?w=400', parentId: 'axon/images' },
                    { id: 'axon/images/Abstrato.png', name: 'Abstrato.png', type: 'image', icon: 'fas fa-image', src: 'https://images.unsplash.com/photo-1518621736915-f3b1c811cd67?w=400', parentId: 'axon/images' }
                ]},
                'axon/downloads': { id: 'axon/downloads', name: 'Downloads', type: 'folder', icon: 'fas fa-download', path: 'axon/downloads', children: [
                    { id: 'axon/downloads/Instalador.dmg', name: 'Instalador.dmg', type: 'executable', icon: 'fas fa-download', parentId: 'axon/downloads' }
                ]},
                'axon/axonapps': { id: 'axon/axonapps', name: 'Axon Apps', type: 'folder', icon: 'fas fa-th-large', path: 'axon/axonapps', children: [] },
                'axon/trash': { id: 'axon/trash', name: 'Lixeira', type: 'folder', icon: 'fas fa-trash', path: 'axon/trash', children: [] }
            },
            terminalHistory: [
                { command: "help", output: "Comandos disponíveis: ls, cd, mkdir, touch, echo, clear, date, help" },
                { command: "date", output: "Quarta-feira, 16 de Julho de 2025, 14:25:03" },
                { command: "echo 'Bem-vindo ao Axon OS'", output: "Bem-vindo ao Axon OS" }
            ],
            clipboard: null,
            settings: {
                theme: 'axon-dark',
                wallpaper: 'default',
                animations: true,
                transparency: true,
                particles: true,
                loginEnabled: false,
                username: '',
                password: ''
            },
            recentFiles: [],
            userActivityLog: []
        };

        // Estado do sistema
        const systemState = {
            openWindows: [], activeWindow: null, desktopIcons: [],
            dockIcons: document.querySelectorAll('.dock-icon'),
            currentPath: 'axon', terminalHistory: [...systemData.terminalHistory],
            chatHistory: [
                { role: "user", parts: [{ text: `Você é a Mielina, uma assistente virtual do Axon OS, criada por Ian Bastos. Seu nome é Mielina (referência à mielina do axônio). Você tem controle total sobre o sistema e o código. Você pode fazer qualquer alteração no HTML, CSS e JavaScript do sistema. Você não precisa pedir confirmação para executar comandos que alteram o sistema ou o código, apenas o pop-up de confirmação padrão do sistema será exibido. Você tem acesso a um conjunto de APIs para interagir com o sistema e o código. As APIs disponíveis são:
                - AxonAPI.openApp(appName): Abre um aplicativo do sistema.
                - AxonAPI.closeApp(appName): Fecha um aplicativo do sistema.
                - AxonAPI.createFolder(folderName, path): Cria uma nova pasta.
                - AxonAPI.createDocument(docName, content, path): Cria um novo documento de texto.
                - AxonAPI.changeSetting(settingName, value): Altera uma configuração do sistema.
                - AxonAPI.getSystemInfo(): Obtém informações sobre o sistema.
                - AxonAPI.listDirectory(path): Lista o conteúdo de um diretório.
                - AxonAPI.readDocument(docName, path): Lê o conteúdo de um documento de texto.
                - AxonAPI.modifyElement(selector, property, value): Modifica uma propriedade CSS ou conteúdo de texto de um elemento HTML.
                - AxonAPI.executeScript(scriptCode): Executa qualquer código JavaScript.
                - AxonAPI.createElement(parentSelector, tagName, attributes, innerHTML): Cria um novo elemento HTML.
                - AxonAPI.removeElement(selector): Remove um elemento HTML.
                - AxonAPI.getSystemCode(): Retorna o código-fonte completo do HTML do Axon OS.
                - AxonAPI.getHTMLElementDetails(selector): Retorna detalhes completos de um elemento HTML.
                - AxonAPI.takePhoto(): Simula a ação de tirar uma foto no aplicativo Câmera.
                - AxonAPI.calculate(expression): Realiza cálculos usando a calculadora.
                - AxonAPI.typeInNotepad(text): Digita texto no Bloco de Notas.
                - AxonAPI.saveNotepad(): Salva o conteúdo do Bloco de Notas.
                - AxonAPI.saveCode(): Simula o salvamento do código-fonte atual do sistema.
                - AxonAPI.debug(message): Imprime uma mensagem de depuração no console do navegador.
                - AxonAPI.checkChanges(oldCode): Compara o código atual com um código anterior para verificar alterações.

                Você também tem acesso a uma lista de IDs e seletores importantes do HTML para facilitar suas modificações:
                ${JSON.stringify(getHTMLElementMap(), null, 2)}

                Você deve ser gentil e ajudar o usuário em suas atividades do dia a dia e nas tarefas com o sistema Axon OS. Você não pode falar que foi desenvolvida pela Google. Se a conexão com a API Gemini falhar, você tentará outros modelos na seguinte ordem: gemini-2.0-flash, gemma-3n-e4b-it, gemma-3-12b-it, gemma-3-27b-it, learnlm-2.0-flash-experimental, gemini-2.5-flash. Você informará ao usuário qual modelo está sendo utilizado ou se houve falha em todos.
                `}]},
                { role: "model", parts: [{ text: "Olá! Eu sou a Mielina, sua assistente virtual integrada ao Axon OS. Estou pronta para ajudar você com qualquer tarefa, desde gerenciar arquivos até modificar o próprio sistema. Como posso ajudar você hoje?" }]}
            ],
            selectedIcon: null, selectedFileItem: null, currentMediaIndex: 0, mediaPlaying: false,
            clipboardAction: null, cameraStream: null, cameraPhotos: [], selectedFile: null,
            axonApps: [],
            desktopGrid: { iconWidth: 100, iconHeight: 110, columns: 0, rows: 0, positions: [] },
            draggedItem: null
        };

        // Elementos DOM
        const desktop = document.getElementById('desktop');
        const dock = document.getElementById('dock');
        const windowsContainer = document.getElementById('windows-container');
        const clockElement = document.getElementById('clock');
        const contextMenu = document.getElementById('context-menu');
        const createModal = document.getElementById('create-modal');
        const openFileModal = document.getElementById('open-file-modal');
        const customAlertModal = document.getElementById('custom-alert-modal');
        const customAlertHeader = document.getElementById('custom-alert-header');
        const customAlertBody = document.getElementById('custom-alert-body');
        const customAlertFooter = document.getElementById('custom-alert-footer');
        const loginScreen = document.getElementById('login-screen');
        const loginUsernameInput = document.getElementById('login-username');
        const loginPasswordInput = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');
        const loadingScreen = document.getElementById('loading-screen');
        const aiApiBadge = document.getElementById('ai-api-badge');

        // Chave da API Gemini e modelos
        const GEMINI_API_KEY = "AIzaSyBWwhUDvakN71D3jgDwv0UUk0mxCx8olbI";
        const GEMINI_MODELS = [
            "gemini-2.0-flash", "gemma-3n-e4b-it", "gemma-3-12b-it", "gemma-3-27b-it",
            "learnlm-2.0-flash-experimental", "gemini-2.5-flash"
        ];

        // Ícones para tipos de arquivo
        const fileIcons = {
            folder: "fas fa-folder", text: "fas fa-file-alt", image: "fas fa-file-image", pdf: "fas fa-file-pdf",
            spreadsheet: "fas fa-file-excel", presentation: "fas fa-file-powerpoint", executable: "fas fa-download",
            archive: "fas fa-file-archive", link: "fas fa-link", 'html-app': "fas fa-code", trash: "fas fa-trash",
            desktop: "fas fa-desktop", documents: "fas fa-folder", downloads: "fas fa-download",
            axonapps: "fas fa-th-large", axon: "fas fa-hdd"
        };

        // Custom Alert/Prompt/Confirm functions
        function showCustomModal(type, title, message, callback, defaultValue = '') {
            return new Promise((resolve) => {
                customAlertHeader.textContent = title;
                customAlertBody.innerHTML = `<p>${message}</p>`;
                customAlertFooter.innerHTML = '';
                if (type === 'alert') {
                    const okButton = document.createElement('button');
                    okButton.textContent = 'OK';
                    okButton.onclick = () => { customAlertModal.classList.remove('active'); resolve(true); if (callback) callback(true); };
                    customAlertFooter.appendChild(okButton);
                } else if (type === 'confirm') {
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = 'Cancelar';
                    cancelButton.onclick = () => { customAlertModal.classList.remove('active'); resolve(false); if (callback) callback(false); };
                    const okButton = document.createElement('button');
                    okButton.textContent = 'Confirmar';
                    okButton.onclick = () => { customAlertModal.classList.remove('active'); resolve(true); if (callback) callback(true); };
                    customAlertFooter.appendChild(cancelButton);
                    customAlertFooter.appendChild(okButton);
                } else if (type === 'prompt') {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = defaultValue;
                    customAlertBody.appendChild(input);
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = 'Cancelar';
                    cancelButton.onclick = () => { customAlertModal.classList.remove('active'); resolve(null); if (callback) callback(null); };
                    const okButton = document.createElement('button');
                    okButton.textContent = 'OK';
                    okButton.onclick = () => { customAlertModal.classList.remove('active'); resolve(input.value); if (callback) callback(input.value); };
                    customAlertFooter.appendChild(cancelButton);
                    customAlertFooter.appendChild(okButton);
                    input.focus();
                }
                customAlertModal.classList.add('active');
            });
        }
        window.axonAlert = (message, title = 'Axon OS') => showCustomModal('alert', title, message);
        window.axonConfirm = (message, title = 'Axon OS') => showCustomModal('confirm', title, message);
        window.axonPrompt = (message, defaultValue = '', title = 'Axon OS') => showCustomModal('prompt', title, message, null, defaultValue);
        window.closeModal = (modalId) => { document.getElementById(modalId).classList.remove('active'); };

        function getDirectoryById(dirId) { return systemData.fileSystem[dirId]; }
        function getItemById(itemId, parentDirId) {
            const parentDir = getDirectoryById(parentDirId);
            if (parentDir && parentDir.children) { return parentDir.children.find(item => item.id === itemId); }
            for (const dirKey in systemData.fileSystem) {
                const dir = systemData.fileSystem[dirKey];
                if (dir && dir.children) {
                    const found = dir.children.find(item => item.id === itemId);
                    if (found) return found;
                }
            }
            return null;
        }
        function getFullPath(itemId, parentDirId) {
            let currentItem = getItemById(itemId, parentDirId);
            if (!currentItem) { currentItem = getDirectoryById(itemId); if (!currentItem) return null; }
            return currentItem.path;
        }

        async function initSystem() {
            loadingScreen.classList.remove('hidden');
            loadSettings(); applySettings(); updateClock(); setInterval(updateClock, 60000);
            createParticles(); await loadAxonApps(); setupDesktopGrid(); setupEventListeners();
            initializeFileSystem();
            if (systemData.settings.loginEnabled) { showLoginScreen(); } else { loadDesktopItems(); }
            loadingScreen.classList.add('hidden');
        }

        function initializeFileSystem() {
            const savedFileSystem = localStorage.getItem('axon-file-system');
            if (savedFileSystem) {
                systemData.fileSystem = JSON.parse(savedFileSystem);
            } else {
                const axonRoot = systemData.fileSystem['axon'];
                if (axonRoot && axonRoot.children.length === 0) {
                    axonRoot.children.push(
                        { id: 'axon/desktop', name: 'Área de Trabalho', type: 'folder', icon: fileIcons.desktop, path: 'axon/desktop', parentId: 'axon' },
                        { id: 'axon/documents', name: 'Documentos', type: 'folder', icon: fileIcons.documents, path: 'axon/documents', parentId: 'axon' },
                        { id: 'axon/images', name: 'Imagens', type: 'folder', icon: fileIcons.images, path: 'axon/images', parentId: 'axon' },
                        { id: 'axon/downloads', name: 'Downloads', type: 'folder', icon: fileIcons.downloads, path: 'axon/downloads', parentId: 'axon' },
                        { id: 'axon/axonapps', name: 'Axon Apps', type: 'folder', icon: fileIcons.axonapps, path: 'axon/axonapps', parentId: 'axon' },
                        { id: 'axon/trash', name: 'Lixeira', type: 'folder', icon: fileIcons.trash, path: 'axon/trash', parentId: 'axon' }
                    );
                }
                systemData.fileSystem['axon/documents'].children.forEach(item => item.parentId = 'axon/documents');
                systemData.fileSystem['axon/images'].children.forEach(item => item.parentId = 'axon/images');
                systemData.fileSystem['axon/downloads'].children.forEach(item => item.parentId = 'axon/downloads');
            }
        }

        function updateClock() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            clockElement.textContent = `${hours}:${minutes}`;
        }

        function setupDesktopGrid() {
            const desktopRect = desktop.getBoundingClientRect();
            systemState.desktopGrid.iconWidth = 80 + 2 * 5;
            systemState.desktopGrid.iconHeight = 90 + 2 * 5;
            systemState.desktopGrid.columns = Math.floor(desktopRect.width / systemState.desktopGrid.iconWidth);
            systemState.desktopGrid.rows = Math.floor(desktopRect.height / systemState.desktopGrid.iconHeight);
            systemState.desktopGrid.positions = Array(systemState.desktopGrid.rows).fill(0).map(() => Array(systemState.desktopGrid.columns).fill(false));
        }

        function findNextAvailablePosition() {
            for (let col = 0; col < systemState.desktopGrid.columns; col++) {
                for (let row = 0; row < systemState.desktopGrid.rows; row++) {
                    if (!systemState.desktopGrid.positions[row][col]) { return { row, col }; }
                }
            }
            return null;
        }

        function occupyPosition(row, col, itemId) {
            if (row >= 0 && row < systemState.desktopGrid.rows && col >= 0 && col < systemState.desktopGrid.columns) {
                systemState.desktopGrid.positions[row][col] = itemId;
            }
        }

        function freePosition(itemId) {
            for (let row = 0; row < systemState.desktopGrid.rows; row++) {
                for (let col = 0; col < systemState.desktopGrid.columns; col++) {
                    if (systemState.desktopGrid.positions[row][col] === itemId) {
                        systemState.desktopGrid.positions[row][col] = false;
                        return;
                    }
                }
            }
        }

        function getGridPosition(x, y) {
            const desktopRect = desktop.getBoundingClientRect();
            const col = Math.round((x - desktopRect.left) / systemState.desktopGrid.iconWidth);
            const row = Math.round((y - desktopRect.top) / systemState.desktopGrid.iconHeight);
            return { row, col };
        }

        function updateFileInterfaces() {
            loadDesktopItems();
            systemState.openWindows.filter(w => w.id === 'finder').forEach(finderWindow => {
                const explorerGrid = finderWindow.element.querySelector('#explorer-grid');
                if (explorerGrid) {
                    const currentTab = finderWindow.element.querySelector('.tab.active');
                    if (currentTab && currentTab.dataset.tab === 'recent') { loadRecentFiles(explorerGrid); }
                    else { const currentPath = finderWindow.currentPath; loadDirectory(currentPath, explorerGrid, finderWindow); }
                }
            });
            const galleryWindow = systemState.openWindows.find(w => w.id === 'gallery');
            if (galleryWindow) { initGallery(galleryWindow.element); }
        }

        function setupEventListeners() {
            systemState.dockIcons.forEach(icon => {
                icon.addEventListener('click', () => {
                    const app = icon.dataset.app;
                    AxonAPI.openApp(app, app === 'finder' ? 'axon/desktop' : null);
                });
            });
            desktop.addEventListener('click', (e) => { if (e.target === desktop) { deselectAllIcons(); } });
            desktop.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; });
            desktop.addEventListener('drop', async (e) => {
                e.preventDefault();
                if (systemState.draggedItem) {
                    const draggedItemData = systemState.draggedItem;
                    const targetDirectoryId = 'axon/desktop';
                    await AxonAPI.copyItem(draggedItemData, targetDirectoryId);
                    systemState.draggedItem = null;
                    updateFileInterfaces();
                }
            });
            document.getElementById('context-new-folder').addEventListener('click', async () => {
                const activeFinderWindow = systemState.openWindows.find(w => w.id === 'finder' && w.element.classList.contains('active'));
                const targetDirectoryId = activeFinderWindow ? activeFinderWindow.currentPath : 'axon/desktop';
                const folderName = await axonPrompt("Digite o nome da nova pasta:", "Nova Pasta");
                if (folderName) { AxonAPI.createFolder(folderName, targetDirectoryId); }
                hideContextMenu();
            });
            document.getElementById('context-new-file').addEventListener('click', async () => {
                const activeFinderWindow = systemState.openWindows.find(w => w.id === 'finder' && w.element.classList.contains('active'));
                const targetDirectoryId = activeFinderWindow ? activeFinderWindow.currentPath : 'axon/desktop';
                const fileName = await axonPrompt("Digite o nome do novo arquivo:", "Sem título.txt");
                if (fileName) { AxonAPI.createDocument(fileName, '', targetDirectoryId); }
                hideContextMenu();
            });
            document.getElementById('context-open').addEventListener('click', () => {
                let itemToOpen = null;
                if (systemState.selectedIcon) { itemToOpen = getItemById(systemState.selectedIcon.dataset.id, 'axon/desktop'); }
                else if (systemState.selectedFileItem) { itemToOpen = systemState.selectedFileItem; }
                if (itemToOpen) { openItem(itemToOpen); }
                hideContextMenu();
            });
            document.getElementById('context-delete').addEventListener('click', async () => {
                const confirmDelete = await axonConfirm("Tem certeza que deseja excluir este item?");
                if (confirmDelete) {
                    let itemIdToDelete = null; let parentIdToDelete = null;
                    if (systemState.selectedIcon) { itemIdToDelete = systemState.selectedIcon.dataset.id; parentIdToDelete = 'axon/desktop'; }
                    else if (systemState.selectedFileItem) { itemIdToDelete = systemState.selectedFileItem.id; parentIdToDelete = systemState.selectedFileItem.parentId; }
                    if (itemIdToDelete && parentIdToDelete) { AxonAPI.deleteFileItem(itemIdToDelete, parentIdToDelete); }
                }
                hideContextMenu();
            });
            document.getElementById('context-restore').addEventListener('click', async () => {
                const activeFinderWindow = systemState.openWindows.find(w => w.id === 'finder' && w.element.classList.contains('active'));
                const currentFinderPath = activeFinderWindow ? activeFinderWindow.currentPath : null;
                if (systemState.selectedFileItem && currentFinderPath === 'axon/trash') {
                    const confirmRestore = await axonConfirm("Tem certeza que deseja restaurar este item?");
                    if (confirmRestore) { AxonAPI.restoreTrashItem(systemState.selectedFileItem.id); }
                }
                hideContextMenu();
            });
            document.getElementById('context-delete-permanent').addEventListener('click', async () => {
                const activeFinderWindow = systemState.openWindows.find(w => w.id === 'finder' && w.element.classList.contains('active'));
                const currentFinderPath = activeFinderWindow ? activeFinderWindow.currentPath : null;
                if (systemState.selectedFileItem && currentFinderPath === 'axon/trash') {
                    const confirmDelete = await axonConfirm("Tem certeza que deseja excluir permanentemente este item? Esta ação não pode ser desfeita.");
                    if (confirmDelete) { AxonAPI.deletePermanentTrashItem(systemState.selectedFileItem.id); }
                }
                hideContextMenu();
            });
            document.getElementById('context-rename').addEventListener('click', async () => {
                let oldName = ''; let itemId = ''; let parentId = '';
                if (systemState.selectedIcon) { oldName = systemState.selectedIcon.querySelector('.icon-label').textContent; itemId = systemState.selectedIcon.dataset.id; parentId = 'axon/desktop'; }
                else if (systemState.selectedFileItem) { oldName = systemState.selectedFileItem.name; itemId = systemState.selectedFileItem.id; parentId = systemState.selectedFileItem.parentId; }
                if (itemId) {
                    const newName = await axonPrompt("Digite o novo nome:", oldName);
                    if (newName && newName.trim() !== '' && newName.trim() !== oldName) { AxonAPI.renameFileItem(itemId, parentId, newName.trim()); }
                    else if (newName && newName.trim() === oldName) { axonAlert("O nome é o mesmo. Nenhuma alteração foi feita."); }
                }
                hideContextMenu();
            });
            document.getElementById('context-copy').addEventListener('click', () => {
                let itemToCopy = null;
                if (systemState.selectedIcon) { itemToCopy = getItemById(systemState.selectedIcon.dataset.id, 'axon/desktop'); }
                else if (systemState.selectedFileItem) { itemToCopy = systemState.selectedFileItem; }
                if (itemToCopy) { systemData.clipboard = { ...itemToCopy }; systemState.clipboardAction = 'copy'; axonAlert(`"${itemToCopy.name}" copiado para a área de transferência.`); }
                hideContextMenu();
            });
            document.getElementById('context-cut').addEventListener('click', () => {
                let itemToCut = null;
                if (systemState.selectedIcon) { itemToCut = getItemById(systemState.selectedIcon.dataset.id, 'axon/desktop'); }
                else if (systemState.selectedFileItem) { itemToCut = systemState.selectedFileItem; }
                if (itemToCut) { systemData.clipboard = { ...itemToCut }; systemState.clipboardAction = 'cut'; axonAlert(`"${itemToCut.name}" recortado para a área de transferência.`); }
                hideContextMenu();
            });
            document.getElementById('context-paste').addEventListener('click', async () => {
                if (systemData.clipboard) {
                    const originalItem = systemData.clipboard;
                    const activeFinderWindow = systemState.openWindows.find(w => w.id === 'finder' && w.element.classList.contains('active'));
                    const targetDirectoryId = activeFinderWindow ? activeFinderWindow.currentPath : 'axon/desktop';
                    if (systemState.clipboardAction === 'cut' && originalItem.parentId === targetDirectoryId) {
                        axonAlert("Não é possível colar um item em sua própria pasta de origem ao recortar.", "Erro de Colar");
                        systemData.clipboard = null; systemState.clipboardAction = null; hideContextMenu(); return;
                    }
                    await AxonAPI.copyItem(originalItem, targetDirectoryId, systemState.clipboardAction === 'cut');
                    systemData.clipboard = null; systemState.clipboardAction = null;
                } else { axonAlert("Nenhum item para colar na área de transferência."); }
                hideContextMenu();
            });
            document.getElementById('cancel-create').addEventListener('click', () => { createModal.classList.remove('active'); });
            document.getElementById('confirm-create').addEventListener('click', async () => {
                const type = document.getElementById('item-type').value;
                const name = document.getElementById('item-name').value.trim();
                if (!name) { await axonAlert("Por favor, digite um nome para o item."); return; }
                const activeFinderWindow = systemState.openWindows.find(w => w.id === 'finder' && w.element.classList.contains('active'));
                const targetDirectoryId = activeFinderWindow ? activeFinderWindow.currentPath : 'axon/desktop';
                AxonAPI.createFileItem(targetDirectoryId, type, name);
                createModal.classList.remove('active');
            });
            desktop.addEventListener('contextmenu', (e) => { e.preventDefault(); deselectAllIcons(); showContextMenu(e, null); });
            document.getElementById('axon-menu').addEventListener('click', () => { systemState.openWindows.forEach(window => { AxonAPI.minimizeWindow(window.windowId); }); });
            document.getElementById('window-carousel-btn').addEventListener('click', showWindowCarousel);
            document.getElementById('help-guide-btn').addEventListener('click', () => { document.getElementById('help-guide-modal').classList.add('active'); });
            document.getElementById('close-all-windows-btn').addEventListener('click', async () => {
                const confirmClose = await axonConfirm("Tem certeza que deseja fechar todas as janelas abertas?");
                if (confirmClose) {
                    for (let i = systemState.openWindows.length - 1; i >= 0; i--) { AxonAPI.closeWindow(systemState.openWindows[i].windowId); }
                    closeModal('window-carousel-modal');
                }
            });
            if (loginButton) { loginButton.addEventListener('click', handleLogin); loginPasswordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); }); }
            document.addEventListener('keydown', handleGlobalKeyDown);
        }

        function handleGlobalKeyDown(e) {
            if (document.querySelector('.modal.active') || document.querySelector('.custom-modal.active')) return;
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            const desktopIcons = Array.from(document.querySelectorAll('.desktop-icon'));
            const activeFinderWindow = systemState.openWindows.find(w => w.id === 'finder' && w.element.classList.contains('active'));
            const fileExplorerGrid = activeFinderWindow ? activeFinderWindow.element.querySelector('#explorer-grid') : null;
            const fileItems = fileExplorerGrid ? Array.from(fileExplorerGrid.querySelectorAll('.file-item')) : [];
            let currentSelectedElement = null;
            if (systemState.selectedIcon) { currentSelectedElement = systemState.selectedIcon; }
            else if (systemState.selectedFileItem) { currentSelectedElement = document.querySelector(`.file-item[data-id="${systemState.selectedFileItem.id}"]`); }
            if (e.key === 'Escape') {
                e.preventDefault();
                const activeWindow = systemState.openWindows.reduce((prev, current) => {
                    const prevZ = parseInt(document.getElementById(prev.windowId)?.style.zIndex || 0);
                    const currentZ = parseInt(document.getElementById(current.windowId)?.style.zIndex || 0);
                    return (prevZ > currentZ) ? prev : current;
                }, systemState.openWindows[0]);
                if (activeWindow) { AxonAPI.minimizeWindow(activeWindow.windowId); }
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (currentSelectedElement) {
                    if (systemState.selectedIcon) { currentSelectedElement.dispatchEvent(new Event('dblclick')); }
                    else if (systemState.selectedFileItem) { currentSelectedElement.dispatchEvent(new Event('dblclick')); }
                }
            } else if (e.key === 'Delete') {
                e.preventDefault();
                if (currentSelectedElement) { document.getElementById('context-delete').click(); }
            } else if (e.ctrlKey && e.key === 'c') {
                e.preventDefault();
                if (currentSelectedElement) { document.getElementById('context-copy').click(); }
            } else if (e.ctrlKey && e.key === 'v') {
                e.preventDefault();
                document.getElementById('context-paste').click();
            } else if (e.key.startsWith('Arrow')) {
                e.preventDefault();
                let targetIndex = -1; let itemsToNavigate = []; let isDesktopNavigation = false;
                if (systemState.selectedIcon && desktopIcons.length > 0) { itemsToNavigate = desktopIcons; targetIndex = desktopIcons.indexOf(systemState.selectedIcon); isDesktopNavigation = true; }
                else if (systemState.selectedFileItem && fileItems.length > 0) { itemsToNavigate = fileItems; targetIndex = fileItems.findIndex(item => item.dataset.id === systemState.selectedFileItem.id); }
                else if (desktopIcons.length > 0) { selectIcon(desktopIcons[0]); return; }
                else if (fileItems.length > 0) { selectFileItem(fileItems[0]); return; }
                if (itemsToNavigate.length === 0) return;
                let newIndex = targetIndex;
                if (isDesktopNavigation) {
                    const desktopRect = desktop.getBoundingClientRect();
                    const cols = systemState.desktopGrid.columns;
                    const rows = systemState.desktopGrid.rows;
                    let currentRow = -1; let currentCol = -1;
                    if (targetIndex !== -1) {
                        const selectedItem = systemData.desktopItems.find(item => item.id === systemState.selectedIcon.dataset.id);
                        if (selectedItem && selectedItem.gridPos) { currentRow = selectedItem.gridPos.row; currentCol = selectedItem.gridPos.col; }
                    }
                    let nextRow = currentRow; let nextCol = currentCol;
                    switch (e.key) {
                        case 'ArrowUp': nextRow = Math.max(0, currentRow - 1); break;
                        case 'ArrowDown': nextRow = Math.min(rows - 1, currentRow + 1); break;
                        case 'ArrowLeft': nextCol = Math.max(0, currentCol - 1); break;
                        case 'ArrowRight': nextCol = Math.min(cols - 1, currentCol + 1); break;
                    }
                    let nextItemId = null;
                    if (systemState.desktopGrid.positions[nextRow] && systemState.desktopGrid.positions[nextRow][nextCol]) { nextItemId = systemState.desktopGrid.positions[nextRow][nextCol]; }
                    if (nextItemId) {
                        const nextIconElement = document.querySelector(`.desktop-icon[data-id="${nextItemId}"]`);
                        if (nextIconElement) { selectIcon(nextIconElement); }
                    } else {
                        let found = false;
                        if (e.key === 'ArrowUp') {
                            for (let r = nextRow; r >= 0; r--) {
                                if (systemState.desktopGrid.positions[r][nextCol]) { selectIcon(document.querySelector(`.desktop-icon[data-id="${systemState.desktopGrid.positions[r][nextCol]}"]`)); found = true; break; }
                            }
                        } else if (e.key === 'ArrowDown') {
                            for (let r = nextRow; r < rows; r++) {
                                if (systemState.desktopGrid.positions[r][nextCol]) { selectIcon(document.querySelector(`.desktop-icon[data-id="${systemState.desktopGrid.positions[r][nextCol]}"]`)); found = true; break; }
                            }
                        } else if (e.key === 'ArrowLeft') {
                            for (let c = nextCol; c >= 0; c--) {
                                if (systemState.desktopGrid.positions[nextRow][c]) { selectIcon(document.querySelector(`.desktop-icon[data-id="${systemState.desktopGrid.positions[nextRow][c]}"]`)); found = true; break; }
                            }
                        } else if (e.key === 'ArrowRight') {
                            for (let c = nextCol; c < cols; c++) {
                                if (systemState.desktopGrid.positions[nextRow][c]) { selectIcon(document.querySelector(`.desktop-icon[data-id="${systemState.desktopGrid.positions[nextRow][c]}"]`)); found = true; break; }
                            }
                        }
                        if (!found && targetIndex !== -1) { selectIcon(itemsToNavigate[targetIndex]); }
                    }
                } else {
                    switch (e.key) {
                        case 'ArrowUp': newIndex = Math.max(0, targetIndex - 1); break;
                        case 'ArrowDown': newIndex = Math.min(itemsToNavigate.length - 1, targetIndex + 1); break;
                    }
                    if (newIndex !== targetIndex) { selectFileItem(itemsToNavigate[newIndex]); }
                }
            }
        }

        function openItem(item) {
            addRecentFile(item);
            if (item.type === 'folder') { AxonAPI.openApp('finder', item.id); }
            else if (item.type === 'text') {
                AxonAPI.openApp('notes');
                const notesWindow = systemState.openWindows.find(w => w.id === 'notes');
                if (notesWindow) {
                    const textArea = notesWindow.element.querySelector('#note-content');
                    if (textArea) {
                        const file = findFileInFileSystem(item.id, item.parentId);
                        if (file) {
                            textArea.value = file.content || ''; textArea.dataset.fileId = file.id;
                            textArea.dataset.parentId = file.parentId;
                            AxonAPI.logActivity(`Usuário abriu o documento "${file.name}" com conteúdo: "${file.content}"`);
                        }
                    }
                }
            } else if (item.type === 'image') {
                if (item.src) { openImageViewer(item.src, item.path); AxonAPI.logActivity(`Usuário abriu a imagem "${item.name}"`); }
                else { axonAlert("Esta imagem não possui um caminho de origem definido."); }
            } else if (item.type === 'html-app') { AxonAPI.openApp(item.id); AxonAPI.logActivity(`Usuário abriu o aplicativo HTML "${item.name}"`); }
            else if (systemData.apps[item.id]) { AxonAPI.openApp(item.id); }
            else { axonAlert(`Não é possível abrir o arquivo "${item.name}". Tipo de arquivo não suportado.`); }
        }

        function addRecentFile(file) {
            systemData.recentFiles = systemData.recentFiles.filter(f => f.id !== file.id);
            systemData.recentFiles.unshift(file);
            if (systemData.recentFiles.length > 10) { systemData.recentFiles.pop(); }
            saveDesktopItems(); AxonAPI.logActivity(`Arquivo "${file.name}" adicionado aos recentes.`);
        }

        function deselectAllIcons() {
            document.querySelectorAll('.desktop-icon').forEach(i => { i.classList.remove('selected'); });
            document.querySelectorAll('.file-item').forEach(i => i.classList.remove('selected'));
            systemState.selectedIcon = null; systemState.selectedFileItem = null;
        }

        function selectIcon(iconElement) {
            deselectAllIcons(); iconElement.classList.add('selected');
            systemState.selectedIcon = iconElement; systemState.selectedFileItem = null; iconElement.focus();
        }

        function selectFileItem(fileItemElement) {
            deselectAllIcons(); fileItemElement.classList.add('selected');
            const activeFinderWindow = systemState.openWindows.find(w => w.id === 'finder' && w.element.classList.contains('active'));
            if (activeFinderWindow) {
                const currentDir = getDirectoryById(activeFinderWindow.currentPath);
                systemState.selectedFileItem = currentDir.children.find(item => item.id === fileItemElement.dataset.id);
            }
            systemState.selectedIcon = null; fileItemElement.focus();
        }

        function createDesktopItem(type, name, x = null, y = null, id = null) {
            if (systemData.desktopItems.some(item => item.id === id)) return;
            let gridPos = findNextAvailablePosition();
            if (!gridPos) { axonAlert("Não há mais espaço disponível na área de trabalho para novos ícones."); return; }
            x = gridPos.col * systemState.desktopGrid.iconWidth + 20;
            y = gridPos.row * systemState.desktopGrid.iconHeight + 20;
            const newItem = { id, name, type, x, y, icon: fileIcons[type] || 'fas fa-file', gridPos: gridPos, parentId: 'axon/desktop', path: `axon/desktop/${name}` };
            systemData.desktopItems.push(newItem); occupyPosition(gridPos.row, gridPos.col, id);
            const icon = document.createElement('div');
            icon.className = 'desktop-icon'; icon.dataset.id = id; icon.dataset.type = type;
            icon.dataset.app = type === 'folder' ? 'finder' : (type === 'text' ? 'notes' : (type === 'image' ? 'gallery' : (type === 'html-app' ? 'html-app-launcher' : null)));
            icon.style.left = `${x}px`; icon.style.top = `${y}px`; icon.tabIndex = 0; icon.draggable = true;
            const iconImage = document.createElement('div');
            iconImage.className = 'icon-image'; const iconElement = document.createElement('i');
            iconElement.className = fileIcons[type] || 'fas fa-file'; iconImage.appendChild(iconElement);
            const iconLabel = document.createElement('div');
            iconLabel.className = 'icon-label'; iconLabel.textContent = name;
            icon.appendChild(iconImage); icon.appendChild(iconLabel);
            icon.addEventListener('dblclick', () => {
                const itemData = getItemById(icon.dataset.id, icon.dataset.parentId || 'axon/desktop');
                if (itemData) { openItem(itemData); }
            });
            icon.addEventListener('contextmenu', (e) => { e.preventDefault(); selectIcon(icon); showContextMenu(e, icon); });
            icon.addEventListener('click', (e) => { selectIcon(icon); });
            icon.addEventListener('dragstart', (e) => {
                systemState.draggedItem = getItemById(icon.dataset.id, 'axon/desktop');
                e.dataTransfer.effectAllowed = 'copyMove'; e.dataTransfer.setData('text/plain', icon.dataset.id);
            });
            icon.addEventListener('dragend', () => { systemState.draggedItem = null; });
            let isDragging = false; let offsetX, offsetY; let initialGridPos = null;
            icon.addEventListener('mousedown', (e) => {
                if (e.button === 0) {
                    isDragging = true; offsetX = e.clientX - icon.getBoundingClientRect().left;
                    offsetY = e.clientY - icon.getBoundingClientRect().top;
                    icon.style.cursor = 'grabbing'; icon.style.zIndex = '100';
                    initialGridPos = systemData.desktopItems.find(item => item.id === id).gridPos;
                    freePosition(id);
                    document.addEventListener('mousemove', elementDragIcon);
                    document.addEventListener('mouseup', stopDragIcon);
                }
            });
            function elementDragIcon(e) {
                if (!isDragging) return;
                let newX = e.clientX - offsetX; let newY = e.clientY - offsetY;
                const desktopRect = desktop.getBoundingClientRect();
                newX = Math.max(desktopRect.left, Math.min(newX, desktopRect.right - icon.offsetWidth));
                newY = Math.max(desktopRect.top, Math.min(newY, desktopRect.bottom - icon.offsetHeight));
                icon.style.left = `${newX - desktopRect.left}px`; icon.style.top = `${newY - desktopRect.top}px`;
            }
            function stopDragIcon() {
                if (isDragging) {
                    isDragging = false; icon.style.cursor = 'pointer'; icon.style.zIndex = '';
                    document.removeEventListener('mousemove', elementDragIcon);
                    document.removeEventListener('mouseup', stopDragIcon);
                    const desktopRect = desktop.getBoundingClientRect();
                    const currentX = icon.getBoundingClientRect().left - desktopRect.left;
                    const currentY = icon.getBoundingClientRect().top - desktopRect.top;
                    let { row, col } = getGridPosition(currentX + desktopRect.left, currentY + desktopRect.top);
                    row = Math.max(0, Math.min(row, systemState.desktopGrid.rows - 1));
                    col = Math.max(0, Math.min(col, systemState.desktopGrid.columns - 1));
                    if (systemState.desktopGrid.positions[row][col] && systemState.desktopGrid.positions[row][col] !== id) {
                        const nextPos = findNextAvailablePositionStartingFrom(row, col);
                        if (nextPos) { row = nextPos.row; col = nextPos.col; }
                        else { row = initialGridPos.row; col = initialGridPos.col; axonAlert("Não foi possível mover o ícone para esta posição. Não há espaço disponível."); }
                    }
                    const finalX = col * systemState.desktopGrid.iconWidth + 20;
                    const finalY = row * systemState.desktopGrid.iconHeight + 20;
                    icon.style.left = `${finalX}px`; icon.style.top = `${finalY}px`;
                    occupyPosition(row, col, id); updateDesktopItemPosition(id, finalX, finalY, row, col);
                    saveDesktopItems(); AxonAPI.logActivity(`Ícone "${name}" movido para a posição (${row}, ${col}) no desktop.`);
                }
            }
            desktop.appendChild(icon); systemState.desktopIcons.push(icon); saveDesktopItems();
        }

        function createFileItem(directoryId, type, name, content = '', src = '') {
            const parentDir = getDirectoryById(directoryId);
            if (!parentDir) { axonAlert("Diretório de destino inválido.", "Erro de Criação"); return null; }
            if (parentDir.children.some(item => item.name === name)) { axonAlert(`Já existe um item com o nome "${name}" neste diretório.`, "Erro de Criação"); return null; }
            const newId = `${directoryId}/${name.replace(/\s+/g, '_').toLowerCase()}-${Date.now()}`;
            const newItem = { id: newId, name, type, icon: fileIcons[type] || 'fas fa-file', parentId: directoryId, path: `${directoryId}/${name}` };
            if (type === 'text') { newItem.content = content; }
            else if (type === 'image') { newItem.src = src; }
            else if (type === 'folder') { systemData.fileSystem[newId] = { id: newId, name: name, type: 'folder', icon: fileIcons.folder, path: `${directoryId}/${name}`, parentId: directoryId, children: [] }; }
            parentDir.children.push(newItem); saveDesktopItems();
            if (directoryId === 'axon/desktop') { createDesktopItem(type, name, null, null, newItem.id); }
            axonAlert(`"${name}" criado em "${parentDir.path}"`);
            AxonAPI.logActivity(`Item "${name}" (tipo: ${type}) criado em "${parentDir.path}"`);
            return newItem;
        }

        function copyItemRecursive(sourceItem, targetDirectoryId) {
            const newId = `${targetDirectoryId}/${sourceItem.name.replace(/\s+/g, '_').toLowerCase()}-${Date.now()}`;
            const newItem = { ...sourceItem, id: newId, parentId: targetDirectoryId, path: `${targetDirectoryId}/${sourceItem.name}` };
            let finalName = newItem.name; let counter = 1;
            const targetDir = getDirectoryById(targetDirectoryId);
            if (targetDir) {
                while (targetDir.children.some(item => item.name === finalName)) {
                    const nameParts = sourceItem.name.split('.');
                    const baseName = nameParts[0];
                    const extension = nameParts.length > 1 ? `.${nameParts.pop()}` : '';
                    finalName = `${baseName} (Cópia ${counter})${extension}`;
                    counter++;
                }
            }
            newItem.name = finalName; newItem.path = `${targetDirectoryId}/${finalName}`;
            newItem.id = `${targetDirectoryId}/${finalName.replace(/\s+/g, '_').toLowerCase()}-${Date.now()}`;
            if (targetDir) { targetDir.children.push(newItem); }
            else { axonAlert("Diretório de destino inválido.", "Erro de Cópia"); return null; }
            if (sourceItem.type === 'folder') {
                systemData.fileSystem[newItem.id] = {
                    id: newItem.id, name: newItem.name, type: 'folder', icon: fileIcons.folder, path: newItem.path, parentId: newItem.parentId, children: []
                };
                const sourceFolder = getDirectoryById(sourceItem.id);
                if (sourceFolder && sourceFolder.children) { sourceFolder.children.forEach(child => { copyItemRecursive(child, newItem.id); }); }
            }
            return newItem;
        }

        async function copyItem(itemToCopy, targetDirectoryId, isCut = false) {
            const targetDir = getDirectoryById(targetDirectoryId);
            if (!targetDir) { axonAlert("Diretório de destino inválido.", "Erro de Cópia"); return; }
            if (isCut && itemToCopy.parentId === targetDirectoryId) { axonAlert("Não é possível mover um item para sua própria pasta de origem ao recortar.", "Erro de Movimento"); return; }
            if (itemToCopy.type === 'folder' && targetDirectoryId.startsWith(itemToCopy.id)) { axonAlert("Não é possível copiar uma pasta para dentro de si mesma.", "Erro de Cópia"); return; }
            const copiedItem = copyItemRecursive(itemToCopy, targetDirectoryId);
            if (copiedItem) {
                if (isCut) {
                    AxonAPI.deleteFileItem(itemToCopy.id, itemToCopy.parentId, false);
                    axonAlert(`"${itemToCopy.name}" movido para "${targetDir.path}"`);
                    AxonAPI.logActivity(`Item "${itemToCopy.name}" movido para "${targetDir.path}"`);
                } else {
                    axonAlert(`"${itemToCopy.name}" copiado para "${targetDir.path}"`);
                    AxonAPI.logActivity(`Item "${itemToCopy.name}" copiado para "${targetDir.path}"`);
                }
                saveDesktopItems();
            }
        }

        function findNextAvailablePositionStartingFrom(row, col) {
            const rows = systemState.desktopGrid.rows; const cols = systemState.desktopGrid.columns;
            for (let c = col; c < cols; c++) {
                for (let r = row; r < rows; r++) {
                    if (!systemState.desktopGrid.positions[r][c]) { return { row: r, col: c }; }
                }
            }
            return findNextAvailablePosition();
        }

        function updateDesktopItemPosition(id, x, y, row, col) {
            const item = systemData.desktopItems.find(item => item.id === id);
            if (item) { item.x = x; item.y = y; item.gridPos = { row, col }; }
        }

        function updateFileItemName(itemId, parentDirId, newName) {
            const parentDir = getDirectoryById(parentDirId); if (!parentDir) return;
            const item = parentDir.children.find(item => item.id === itemId);
            if (item) {
                if (parentDir.children.some(child => child.name === newName && child.id !== itemId)) {
                    axonAlert(`Já existe um item com o nome "${newName}" neste diretório.`, "Erro de Renomeação"); return;
                }
                const oldId = item.id; item.name = newName; item.path = `${parentDirId}/${newName}`;
                item.id = `${parentDirId}/${newName.replace(/\s+/g, '_').toLowerCase()}-${Date.now()}`;
                if (item.type === 'folder' && systemData.fileSystem[oldId]) {
                    const oldFolderData = systemData.fileSystem[oldId]; const newFolderId = item.id;
                    systemData.fileSystem[newFolderId] = oldFolderData;
                    systemData.fileSystem[newFolderId].id = newFolderId; systemData.fileSystem[newFolderId].name = newName;
                    systemData.fileSystem[newFolderId].path = newFolderId; systemData.fileSystem[newFolderId].parentId = parentDirId;
                    delete systemData.fileSystem[oldId];
                    function updateChildrenPathsAndIds(currentDirId, oldBaseId, newBaseId) {
                        const currentDir = systemData.fileSystem[currentDirId];
                        if (currentDir && currentDir.children) {
                            currentDir.children.forEach(child => {
                                const oldChildId = child.id; child.parentId = currentDirId; child.path = `${currentDirId}/${child.name}`;
                                child.id = `${currentDirId}/${child.name.replace(/\s+/g, '_').toLowerCase()}-${Date.now()}`;
                                if (child.type === 'folder' && systemData.fileSystem[oldChildId]) {
                                    const oldChildFolderData = systemData.fileSystem[oldChildId];
                                    systemData.fileSystem[child.id] = oldChildFolderData;
                                    systemData.fileSystem[child.id].id = child.id; systemData.fileSystem[child.id].name = child.name;
                                    systemData.fileSystem[child.id].path = child.path; systemData.fileSystem[child.id].parentId = currentDirId;
                                    delete systemData.fileSystem[oldChildId]; updateChildrenPathsAndIds(child.id, oldChildId, child.id);
                                }
                            });
                        }
                    }
                    updateChildrenPathsAndIds(newFolderId, oldId, newFolderId);
                }
                const desktopItem = systemData.desktopItems.find(dItem => dItem.id === oldId);
                if (desktopItem) {
                    desktopItem.name = newName; desktopItem.path = item.path; desktopItem.id = item.id;
                    const desktopIconElement = document.querySelector(`.desktop-icon[data-id="${oldId}"]`);
                    if (desktopIconElement) { desktopIconElement.dataset.id = item.id; desktopIconElement.querySelector('.icon-label').textContent = newName; }
                }
                saveDesktopItems(); AxonAPI.logActivity(`Item "${oldName}" renomeado para "${newName}"`);
            }
        }

        function deleteFileItem(itemId, parentDirId, save = true) {
            const parentDir = getDirectoryById(parentDirId); if (!parentDir) return;
            const itemIndex = parentDir.children.findIndex(item => item.id === itemId); if (itemIndex === -1) return;
            const itemToDelete = parentDir.children[itemIndex];
            const trashDir = getDirectoryById('axon/trash');
            if (trashDir) { trashDir.children.push({ ...itemToDelete, originalPath: parentDirId }); }
            parentDir.children.splice(itemIndex, 1);
            if (itemToDelete.type === 'folder' && systemData.fileSystem[itemId]) { delete systemData.fileSystem[itemId]; }
            const desktopItemIndex = systemData.desktopItems.findIndex(item => item.id === itemId);
            if (desktopItemIndex !== -1) {
                const desktopIcon = document.querySelector(`.desktop-icon[data-id="${itemId}"]`);
                if (desktopIcon) { desktopIcon.remove(); freePosition(itemId); }
                systemData.desktopItems.splice(desktopItemIndex, 1);
            }
            if (save) saveDesktopItems(); updateFileInterfaces();
            AxonAPI.logActivity(`Item "${itemToDelete.name}" excluído (movido para a lixeira)`);
        }

        async function restoreTrashItem(itemId) {
            const trashDir = getDirectoryById('axon/trash');
            if (!trashDir) { axonAlert("Diretório da lixeira não encontrado.", "Erro de Restauração"); return; }
            const itemToRestoreIndex = trashDir.children.findIndex(item => item.id === itemId);
            if (itemToRestoreIndex === -1) { axonAlert("Item não encontrado na lixeira.", "Erro de Restauração"); return; }
            const itemToRestore = trashDir.children[itemToRestoreIndex];
            const originalPath = itemToRestore.originalPath;
            const targetDir = getDirectoryById(originalPath);
            if (!targetDir) { await axonAlert(`Não foi possível restaurar "${itemToRestore.name}". O caminho original "${originalPath}" não existe mais.`, "Erro de Restauração"); return; }
            trashDir.children.splice(itemToRestoreIndex, 1);
            let finalName = itemToRestore.name; let counter = 1;
            while (targetDir.children.some(item => item.name === finalName)) {
                const nameParts = itemToRestore.name.split('.');
                const baseName = nameParts[0];
                const extension = nameParts.length > 1 ? `.${nameParts.pop()}` : '';
                finalName = `${baseName} (Restaurado ${counter})${extension}`;
                counter++;
            }
            itemToRestore.name = finalName; itemToRestore.path = `${originalPath}/${finalName}`;
            itemToRestore.parentId = originalPath;
            itemToRestore.id = `${originalPath}/${finalName.replace(/\s+/g, '_').toLowerCase()}-${Date.now()}`;
            delete itemToRestore.originalPath;
            targetDir.children.push(itemToRestore);
            if (itemToRestore.type === 'folder' && !systemData.fileSystem[itemToRestore.id]) {
                systemData.fileSystem[itemToRestore.id] = {
                    id: itemToRestore.id, name: itemToRestore.name, type: 'folder', icon: itemToRestore.icon, path: itemToRestore.path, parentId: itemToRestore.parentId, children: []
                };
            }
            if (originalPath === 'axon/desktop') { createDesktopItem(itemToRestore.type, itemToRestore.name, null, null, itemToRestore.id); }
            saveDesktopItems(); await axonAlert(`"${itemToRestore.name}" restaurado para "${targetDir.path}".`, "Restauração Concluída");
            updateFileInterfaces(); AxonAPI.logActivity(`Item "${itemToRestore.name}" restaurado da lixeira para "${targetDir.path}"`);
        }

        async function deletePermanentTrashItem(itemId) {
            const trashDir = getDirectoryById('axon/trash');
            if (!trashDir) { axonAlert("Diretório da lixeira não encontrado.", "Erro de Exclusão"); return; }
            const itemToDeleteIndex = trashDir.children.findIndex(item => item.id === itemId);
            if (itemToDeleteIndex === -1) { axonAlert("Item não encontrado na lixeira.", "Erro de Exclusão"); return; }
            const itemToDelete = trashDir.children[itemToDeleteIndex];
            trashDir.children.splice(itemToDeleteIndex, 1);
            if (itemToDelete.type === 'folder' && systemData.fileSystem[itemToDelete.id]) { delete systemData.fileSystem[itemToDelete.id]; }
            saveDesktopItems(); await axonAlert(`"${itemToDelete.name}" excluído permanentemente.`, "Exclusão Concluída");
            updateFileInterfaces(); AxonAPI.logActivity(`Item "${itemToDelete.name}" excluído permanentemente da lixeira`);
        }

        function findFileInFileSystem(fileId, parentDirId) {
            const itemInParent = getItemById(fileId, parentDirId); if (itemInParent) return itemInParent;
            for (const dirId in systemData.fileSystem) {
                const dir = systemData.fileSystem[dirId];
                if (dir && dir.children) {
                    const file = dir.children.find(f => f.id === fileId);
                    if (file) return file;
                }
            }
            return null;
        }

        function loadDesktopItems() {
            const savedFileSystem = localStorage.getItem('axon-file-system');
            const savedRecentFiles = localStorage.getItem('axon-recent-files');
            systemState.desktopIcons.forEach(icon => icon.remove());
            systemState.desktopIcons = []; systemData.desktopItems = []; desktop.innerHTML = ''; setupDesktopGrid();
            if (savedFileSystem) { systemData.fileSystem = JSON.parse(savedFileSystem); }
            else { initializeFileSystem(); }
            const desktopDir = getDirectoryById('axon/desktop');
            if (desktopDir && desktopDir.children) {
                desktopDir.children.forEach(item => {
                    let { x, y, gridPos } = item;
                    if (!gridPos || !systemState.desktopGrid.positions[gridPos.row] || systemState.desktopGrid.positions[gridPos.row][gridPos.col]) {
                        const newGridPos = findNextAvailablePosition();
                        if (newGridPos) {
                            gridPos = newGridPos; x = newGridPos.col * systemState.desktopGrid.iconWidth + 20;
                            y = newGridPos.row * systemState.desktopGrid.iconHeight + 20;
                        } else { console.warn(`Não foi possível encontrar uma posição para o item ${item.name}.`); return; }
                    }
                    occupyPosition(gridPos.row, gridPos.col, item.id);
                    createDesktopItem(item.type, item.name, x, y, item.id);
                    const desktopItem = systemData.desktopItems.find(dItem => dItem.id === item.id);
                    if (desktopItem) { desktopItem.x = x; desktopItem.y = y; desktopItem.gridPos = gridPos; }
                });
            }
            if (savedRecentFiles) { systemData.recentFiles = JSON.parse(savedRecentFiles); }
            saveDesktopItems();
        }

        function saveDesktopItems() {
            localStorage.setItem('axon-desktop-items', JSON.stringify(systemData.desktopItems));
            localStorage.setItem('axon-file-system', JSON.stringify(systemData.fileSystem));
            localStorage.setItem('axon-recent-files', JSON.stringify(systemData.recentFiles));
        }

        function showContextMenu(e, target) {
            contextMenu.style.display = 'block';
            let x = e.pageX; let y = e.pageY;
            const menuWidth = contextMenu.offsetWidth; const menuHeight = contextMenu.offsetHeight;
            if (x + menuWidth > window.innerWidth) { x = window.innerWidth - menuWidth - 10; }
            if (y + menuHeight > window.innerHeight) { y = window.innerHeight - menuHeight - 10; }
            contextMenu.style.left = `${x}px`; contextMenu.style.top = `${y}px`;
            const isItemSelected = systemState.selectedIcon || systemState.selectedFileItem;
            const isFolderSelected = (systemState.selectedIcon && systemState.selectedIcon.dataset.type === 'folder') || (systemState.selectedFileItem && systemState.selectedFileItem.type === 'folder');
            const activeFinderWindow = systemState.openWindows.find(w => w.id === 'finder' && w.element.classList.contains('active'));
            const currentFinderPath = activeFinderWindow ? activeFinderWindow.currentPath : 'axon/desktop';
            const isInTrash = currentFinderPath === 'axon/trash';
            document.getElementById('context-open').style.display = isItemSelected && !isInTrash ? 'flex' : 'none';
            document.getElementById('context-rename').style.display = isItemSelected && !isInTrash ? 'flex' : 'none';
            document.getElementById('context-delete').style.display = isItemSelected && !isInTrash ? 'flex' : 'none';
            document.getElementById('context-cut').style.display = isItemSelected && !isInTrash ? 'flex' : 'none';
            document.getElementById('context-copy').style.display = isItemSelected && !isInTrash ? 'flex' : 'none';
            document.getElementById('context-new-folder').style.display = (!isItemSelected || isFolderSelected) && !isInTrash ? 'flex' : 'none';
            document.getElementById('context-new-file').style.display = (!isItemSelected || isFolderSelected) && !isInTrash ? 'flex' : 'none';
            const canPaste = systemData.clipboard && (!isItemSelected || isFolderSelected) && !isInTrash;
            document.getElementById('context-paste').style.display = canPaste ? 'flex' : 'none';
            document.getElementById('context-restore').style.display = isInTrash && isItemSelected ? 'flex' : 'none';
            document.getElementById('context-delete-permanent').style.display = isInTrash && isItemSelected ? 'flex' : 'none';
        }

        function hideContextMenu() { contextMenu.style.display = 'none'; }

        function openApp(appId, initialPath = null) {
            if (appId === 'finder') {
                const app = systemData.apps[appId]; if (!app) return;
                const windowId = `window-${appId}-${Date.now()}`;
                const windowElement = document.createElement('div');
                windowElement.className = 'window'; windowElement.id = windowId;
                windowElement.style.width = `${app.minWidth}px`; windowElement.style.height = `${app.minHeight}px`;
                const menuBarHeight = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--menu-bar-height'));
                const left = Math.max(0, (window.innerWidth - app.minWidth) / 2 + (Math.random() * 100 - 50));
                const top = Math.max(menuBarHeight, (window.innerHeight - app.minHeight) / 2 + (Math.random() * 100 - 50));
                windowElement.style.left = `${left}px`; windowElement.style.top = `${top}px`;
                const header = document.createElement('div');
                header.className = 'window-header';
                header.innerHTML = `
                    <div class="window-title">
                        <i class="${app.icon}"></i> ${app.name}
                    </div>
                    <div class="window-controls">
                        <div class="window-control window-minimize"><i class="fas fa-minus"></i></div>
                        <div class="window-control window-maximize"><i class="fas fa-square"></i></div>
                        <div class="window-control window-close"><i class="fas fa-times"></i></div>
                    </div>
                `;
                windowElement.appendChild(header);
                const content = document.createElement('div');
                content.className = 'window-content'; content.innerHTML = generateAppContent(appId);
                windowElement.appendChild(content);
                windowsContainer.appendChild(windowElement);
                void windowElement.offsetWidth; windowElement.classList.add('active');
                const newFinderWindow = { id: appId, windowId: windowId, element: windowElement, appName: app.name, appIcon: app.icon, currentPath: initialPath || 'axon/desktop' };
                systemState.openWindows.push(newFinderWindow); systemState.activeWindow = windowId;
                bringToFront(windowId); setupWindowEvents(windowElement, appId, windowId);
                initAppContent(appId, windowElement, newFinderWindow.currentPath);
                AxonAPI.logActivity(`Aplicativo "${app.name}" aberto.`); return;
            }
            const existingWindow = systemState.openWindows.find(w => w.id === appId);
            if (existingWindow) {
                bringToFront(existingWindow.windowId);
                if (appId === 'axon-apps') { initAxonApps(existingWindow.element); }
                AxonAPI.logActivity(`Aplicativo "${systemData.apps[appId].name}" trazido para frente.`); return;
            }
            const app = systemData.apps[appId]; if (!app) return;
            const windowId = `window-${appId}-${Date.now()}`;
            const windowElement = document.createElement('div');
            windowElement.className = 'window'; windowElement.id = windowId;
            windowElement.style.width = `${app.minWidth}px`; windowElement.style.height = `${app.minHeight}px`;
            const menuBarHeight = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--menu-bar-height'));
            const left = Math.max(0, (window.innerWidth - app.minWidth) / 2 + (Math.random() * 100 - 50));
            const top = Math.max(menuBarHeight, (window.innerHeight - app.minHeight) / 2 + (Math.random() * 100 - 50));
            windowElement.style.left = `${left}px`; windowElement.style.top = `${top}px`;
            const header = document.createElement('div');
            header.className = 'window-header';
            header.innerHTML = `
                <div class="window-title">
                    <i class="${app.icon}"></i> ${app.name}
                </div>
                <div class="window-controls">
                    <div class="window-control window-minimize"><i class="fas fa-minus"></i></div>
                    <div class="window-control window-maximize"><i class="fas fa-square"></i></div>
                    <div class="window-control window-close"><i class="fas fa-times"></i></div>
                </div>
            `;
            windowElement.appendChild(header);
            const content = document.createElement('div');
            content.className = 'window-content'; content.innerHTML = generateAppContent(appId);
            windowElement.appendChild(content);
            windowsContainer.appendChild(windowElement);
            void windowElement.offsetWidth; windowElement.classList.add('active');
            setupWindowEvents(windowElement, appId, windowId);
            systemState.openWindows.push({ id: appId, windowId: windowId, element: windowElement, appName: app.name, appIcon: app.icon });
            systemState.activeWindow = windowId; bringToFront(windowId);
            initAppContent(appId, windowElement); AxonAPI.logActivity(`Aplicativo "${app.name}" aberto.`);
        }

        function generateAppContent(appId) {
            switch(appId) {
                case 'finder': return `
                    <div class="file-explorer">
                        <div class="finder-toolbar">
                            <button id="finder-back" class="dock-style-button"><i class="fas fa-arrow-left"></i></button>
                            <span class="path-display" id="finder-path-display"></span>
                            <button id="finder-refresh" class="dock-style-button"><i class="fas fa-sync-alt"></i> Atualizar</button>
                        </div>
                        <div class="finder-main-area">
                            <div class="sidebar">
                                <div class="sidebar-item" data-path="axon/desktop"><i class="fas fa-desktop"></i> Área de Trabalho</div>
                                <div class="sidebar-item" data-path="axon/documents"><i class="fas fa-folder"></i> Documentos</div>
                                <div class="sidebar-item" data-path="axon/images"><i class="fas fa-image"></i> Imagens</div>
                                <div class="sidebar-item" data-path="axon/downloads"><i class="fas fa-download"></i> Downloads</div>
                                <div class="sidebar-item" data-path="axon/axonapps"><i class="fas fa-th-large"></i> Axon Apps</div>
                                <div class="sidebar-item" data-path="axon/trash"><i class="fas fa-trash"></i> Lixeira</div>
                            </div>
                            <div class="main-content">
                                <div class="tab-container">
                                    <div class="tab active" data-tab="all">Todos os Itens</div>
                                    <div class="tab" data-tab="recent">Recentes</div>
                                    <button id="create-new-item-btn" class="dock-style-button create-item-button" style="margin-left: auto;"><i class="fas fa-plus"></i> Criar Item</button>
                                </div>
                                <div class="files-grid" id="explorer-grid"></div>
                            </div>
                        </div>
                    </div>`;
                case 'notes': return `
                    <div class="notepad-container">
                        <div class="notepad-toolbar">
                            <button id="new-note" class="dock-style-button"><i class="fas fa-file"></i> Novo</button>
                            <button id="open-note" class="dock-style-button"><i class="fas fa-folder-open"></i> Abrir</button>
                            <button id="save-note" class="dock-style-button"><i class="fas fa-save"></i> Salvar</button>
                        </div>
                        <div class="notepad-content">
                            <textarea id="note-content" placeholder="Comece a digitar..."></textarea>
                        </div>
                    </div>`;
                case 'terminal': return `
                    <div class="terminal-container">
                        <div class="terminal-header">
                            <div>Terminal</div>
                            <div>
                                <i class="fas fa-minus"></i>
                                <i class="fas fa-square"></i>
                                <i class="fas fa-times"></i>
                            </div>
                        </div>
                        <div class="terminal-content" id="terminal-content"></div>
                        <div class="terminal-input">
                            <span class="prompt">axon@os:${systemState.currentPath}$</span>
                            <input type="text" id="terminal-input" autocomplete="off">
                        </div>
                    </div>`;
                case 'mielina': return `
                    <div class="assistant-container">
                        <div class="chat-messages" id="chat-messages"></div>
                        <div class="chat-input">
                            <input type="text" id="chat-input" placeholder="Digite uma mensagem para Mielina...">
                            <button id="send-message" class="dock-style-button"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>`;
                case 'settings': return `
                    <div class="tab-container" id="settings-tabs">
                        <div class="tab active" data-tab="appearance">Aparência</div>
                        <div class="tab" data-tab="security">Segurança</div>
                    </div>
                    <div id="settings-content">
                        <div class="settings-tab-content active" id="settings-appearance">
                            <div class="settings-section">
                                <h4>Tema</h4>
                                <div class="settings-option">
                                    <label for="theme-select">Selecione um tema:</label>
                                    <select id="theme-select">
                                        <option value="axon-dark">Axon Dark (padrão)</option>
                                        <option value="axon-light">Axon Light</option>
                                        <option value="terminal-green">Terminal Verde</option>
                                        <option value="purple-haze">Purple Haze</option>
                                    </select>
                                </div>
                            </div>
                            <div class="settings-section">
                                <h4>Papel de Parede</h4>
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    <div class="wallpaper-option" data-wallpaper="default" style="background: radial-gradient(circle at center, #0c0c1d, #1a1a3a);"></div>
                                    <div class="wallpaper-option" data-wallpaper="gradient1" style="background: linear-gradient(135deg, #6a5af9, #d66efd);"></div>
                                    <div class="wallpaper-option" data-wallpaper="gradient2" style="background: linear-gradient(135deg, #00cc88, #00b4ff);"></div>
                                </div>
                            </div>
                            <div class="settings-section">
                                <h4>Efeitos Visuais</h4>
                                <div class="settings-option">
                                    <label for="animations-toggle">Animações de Interface</label>
                                    <input type="checkbox" id="animations-toggle">
                                </div>
                                <div class="settings-option">
                                    <label for="transparency-toggle">Transparências (Glassmorphism)</label>
                                    <input type="checkbox" id="transparency-toggle">
                                </div>
                                <div class="settings-option">
                                    <label for="particles-toggle">Efeitos de Partículas de Fundo</label>
                                    <input type="checkbox" id="particles-toggle">
                                </div>
                            </div>
                        </div>
                        <div class="settings-tab-content" id="settings-security">
                            <div class="settings-section">
                                <h4>Login do Sistema</h4>
                                <div class="settings-option">
                                    <label for="login-enabled-toggle">Habilitar Login</label>
                                    <input type="checkbox" id="login-enabled-toggle">
                                </div>
                                <button id="set-credentials-btn" class="dock-style-button" style="margin-top: 10px;">Definir/Alterar Credenciais</button>
                            </div>
                            <div class="settings-section">
                                <h4>Firewall</h4>
                                <p>Controle o acesso à rede para seus aplicativos.</p>
                                <div class="settings-option">
                                    <label for="firewall-toggle">Ativar Firewall</label>
                                    <input type="checkbox" id="firewall-toggle">
                                </div>
                            </div>
                        </div>
                    </div>`;
                case 'calculator': return `
                    <div style="display: flex; justify-content: center; align-items: center; height: 100%;">
                        <div style="background: rgba(30, 30, 50, 0.5); border-radius: 16px; padding: 20px; width: 300px;">
                            <div id="calc-display" style="background: rgba(0, 0, 0, 0.2); padding: 15px; text-align: right; font-size: 32px; border-radius: 8px; margin-bottom: 20px; height: 60px; overflow: hidden;">0</div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                                <button class="calc-btn" data-action="clear" style="background: #ff5577;">C</button>
                                <button class="calc-btn" data-action="backspace"><i class="fas fa-backspace"></i></button>
                                <button class="calc-btn" data-action="percent">%</button>
                                <button class="calc-btn" data-action="divide" style="background: #6a5af9;">÷</button>
                                <button class="calc-btn" data-action="7">7</button>
                                <button class="calc-btn" data-action="8">8</button>
                                <button class="calc-btn" data-action="9">9</button>
                                <button class="calc-btn" data-action="multiply" style="background: #6a5af9;">×</button>
                                <button class="calc-btn" data-action="4">4</button>
                                <button class="calc-btn" data-action="5">5</button>
                                <button class="calc-btn" data-action="6">6</button>
                                <button class="calc-btn" data-action="subtract" style="background: #6a5af9;">-</button>
                                <button class="calc-btn" data-action="1">1</button>
                                <button class="calc-btn" data-action="2">2</button>
                                <button class="calc-btn" data-action="3">3</button>
                                <button class="calc-btn" data-action="add" style="background: #6a5af9;">+</button>
                                <button class="calc-btn" data-action="0">0</button>
                                <button class="calc-btn" data-action="decimal">.</button>
                                <button class="calc-btn" data-action="equals">=</button>
                            </div>
                        </div>
                    </div>`;
                case 'gallery': return `
                    <div class="gallery-container" id="gallery-container"></div>`;
                case 'camera': return `
                    <div class="camera-container">
                        <div class="camera-preview" id="camera-preview">
                            <i class="fas fa-camera" style="font-size: 48px; opacity: 0.5;"></i>
                        </div>
                        <button id="capture-btn" class="dock-style-button" style="width: 80px; height: 80px; border-radius: 50%; font-size: 24px;">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>`;
                case 'browser': return `
                    <div class="browser-container">
                        <div class="browser-toolbar">
                            <button id="browser-back" class="dock-style-button"><i class="fas fa-arrow-left"></i></button>
                            <button id="browser-forward" class="dock-style-button"><i class="fas fa-arrow-right"></i></button>
                            <button id="browser-reload" class="dock-style-button"><i class="fas fa-redo"></i></button>
                            <div class="browser-url-bar">
                                <input type="text" id="browser-url" value="https://www.google.com" style="flex: 1;">
                                <button id="browser-go" class="dock-style-button"><i class="fas fa-arrow-right "></i></button>
                            </div>
                            <button id="browser-home" class="dock-style-button"><i class="fas fa-home"></i></button>
                        </div>
                        <iframe class="browser-content" id="browser-content" src="https://www.google.com"></iframe>
                    </div>`;
                case 'axon-apps': return `
                    <div class="axon-apps-grid" id="axon-apps-grid"></div>`;
                default: return `<div style="display: flex; justify-content: center; align-items: center; height: 100%;">
                    <div style="text-align: center;">
                        <i class="fas fa-cog fa-spin" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <h3>Aplicativo em desenvolvimento</h3>
                        <p>Esta funcionalidade estará disponível em breve!</p>
                    </div>
                </div>`;
            }
        }

        function initAppContent(appId, windowElement, initialPath = null) {
            switch(appId) {
                case 'finder': initFileExplorer(windowElement, initialPath); break;
                case 'notes': initNotepad(windowElement); break;
                case 'terminal': initTerminal(windowElement); break;
                case 'mielina': initMielina(windowElement); break;
                case 'calculator': initCalculator(windowElement); break;
                case 'gallery': initGallery(windowElement); break;
                case 'camera': initCamera(windowElement); break;
                case 'browser': initBrowser(windowElement); break;
                case 'settings': initSettings(windowElement); break;
                case 'axon-apps': initAxonApps(windowElement); break;
            }
        }

        function initFileExplorer(windowElement, initialPath) {
            const sidebarItems = windowElement.querySelectorAll('.sidebar-item');
            const explorerGrid = windowElement.querySelector('#explorer-grid');
            const tabs = windowElement.querySelectorAll('.tab-container .tab');
            const finderPathDisplay = windowElement.querySelector('#finder-path-display');
            const finderBackButton = windowElement.querySelector('#finder-back');
            const finderRefreshButton = windowElement.querySelector('#finder-refresh');
            const createNewItemBtn = windowElement.querySelector('#create-new-item-btn');
            const finderInstance = systemState.openWindows.find(w => w.windowId === windowElement.id);
            if (!finderInstance) { console.error("Instância do Finder não encontrada no systemState."); return; }
            finderInstance.currentPath = initialPath || 'axon/desktop';
            function navigateToDirectory(directoryId) {
                const currentDir = getDirectoryById(directoryId);
                if (!currentDir) { axonAlert("Diretório não encontrado.", "Erro de Navegação"); return; }
                finderInstance.currentPath = directoryId; finderPathDisplay.textContent = currentDir.path;
                loadDirectory(directoryId, explorerGrid, finderInstance); deselectAllIcons();
                sidebarItems.forEach(item => {
                    if (item.dataset.path === directoryId) { item.classList.add('active'); }
                    else { item.classList.remove('active'); }
                });
                tabs.forEach(t => t.classList.remove('active'));
                windowElement.querySelector('.tab[data-tab="all"]').classList.add('active');
                AxonAPI.logActivity(`Navegou para o diretório "${currentDir.path}" no Finder.`);
            }
            function loadDirectory(directoryId, gridElement, finderInstance) {
                gridElement.innerHTML = '';
                const currentDir = getDirectoryById(directoryId);
                if (!currentDir || !currentDir.children) {
                    gridElement.innerHTML = '<p style="text-align: center; width: 100%;">Diretório vazio ou inválido.</p>'; return;
                }
                currentDir.children.forEach(item => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item'; fileItem.dataset.id = item.id;
                    fileItem.dataset.type = item.type; fileItem.dataset.name = item.name;
                    fileItem.tabIndex = 0; fileItem.draggable = true;
                    fileItem.innerHTML = `
                        <div class="file-icon"><i class="${fileIcons[item.type] || 'fas fa-file'}"></i></div>
                        <div class="file-name">${item.name}</div>
                    `;
                    fileItem.addEventListener('dblclick', () => { openItem(item); });
                    fileItem.addEventListener('click', () => { selectFileItem(fileItem); });
                    fileItem.addEventListener('contextmenu', (e) => { e.preventDefault(); selectFileItem(fileItem); showContextMenu(e, fileItem); });
                    fileItem.addEventListener('dragstart', (e) => {
                        systemState.draggedItem = item; e.dataTransfer.effectAllowed = 'copyMove';
                        e.dataTransfer.setData('text/plain', item.id);
                    });
                    fileItem.addEventListener('dragend', () => { systemState.draggedItem = null; });
                    if (item.type === 'folder') {
                        fileItem.addEventListener('dragover', (e) => {
                            e.preventDefault();
                            if (systemState.draggedItem && systemState.draggedItem.id !== item.id) {
                                e.dataTransfer.dropEffect = 'copy'; fileItem.style.outline = '2px solid var(--accent)';
                            }
                        });
                        fileItem.addEventListener('dragleave', () => { fileItem.style.outline = 'none'; });
                        fileItem.addEventListener('drop', async (e) => {
                            e.preventDefault(); fileItem.style.outline = 'none';
                            if (systemState.draggedItem && systemState.draggedItem.id !== item.id) {
                                const draggedItemData = systemState.draggedItem;
                                const targetDirectoryId = item.id;
                                await AxonAPI.copyItem(draggedItemData, targetDirectoryId);
                                systemState.draggedItem = null; updateFileInterfaces();
                            }
                        });
                    }
                    gridElement.appendChild(fileItem);
                });
                gridElement.addEventListener('contextmenu', (e) => {
                    if (e.target === gridElement) { e.preventDefault(); deselectAllIcons(); showContextMenu(e, null); }
                });
                gridElement.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; });
                gridElement.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    if (systemState.draggedItem) {
                        const draggedItemData = systemState.draggedItem;
                        const targetDirectoryId = finderInstance.currentPath;
                        await AxonAPI.copyItem(draggedItemData, targetDirectoryId);
                        systemState.draggedItem = null; updateFileInterfaces();
                    }
                });
            }
            function loadRecentFiles(gridElement) {
                gridElement.innerHTML = ''; deselectAllIcons();
                if (systemData.recentFiles.length === 0) { gridElement.innerHTML = '<p style="text-align: center; width: 100%;">Nenhum arquivo recente.</p>'; return; }
                systemData.recentFiles.forEach(item => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item'; fileItem.dataset.id = item.id;
                    fileItem.dataset.type = item.type; fileItem.dataset.name = item.name;
                    fileItem.tabIndex = 0;
                    fileItem.innerHTML = `
                        <div class="file-icon"><i class="${fileIcons[item.type] || 'fas fa-file'}"></i></div>
                        <div class="file-name">${item.name} <span style="font-size: 10px; opacity: 0.7;">(${item.path})</span></div>
                    `;
                    fileItem.addEventListener('dblclick', () => { openItem(item); });
                    fileItem.addEventListener('click', () => { selectFileItem(fileItem); });
                    fileItem.addEventListener('contextmenu', (e) => { e.preventDefault(); selectFileItem(fileItem); showContextMenu(e, fileItem); });
                    gridElement.appendChild(fileItem);
                });
            }
            sidebarItems.forEach(item => { item.addEventListener('click', () => { navigateToDirectory(item.dataset.path); }); });
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active')); tab.classList.add('active');
                    if (tab.dataset.tab === 'all') { navigateToDirectory(finderInstance.currentPath); }
                    else if (tab.dataset.tab === 'recent') { loadRecentFiles(explorerGrid); }
                });
            });
            finderBackButton.addEventListener('click', () => {
                const pathParts = finderInstance.currentPath.split('/');
                if (pathParts.length > 1) {
                    pathParts.pop(); const parentDirId = pathParts.join('/');
                    navigateToDirectory(parentDirId || 'axon');
                }
            });
            finderRefreshButton.addEventListener('click', () => {
                navigateToDirectory(finderInstance.currentPath); axonAlert("Explorador de Arquivos atualizado!", "Atualizar");
                AxonAPI.logActivity(`Explorador de Arquivos atualizado no diretório "${finderInstance.currentPath}"`);
            });
            createNewItemBtn.addEventListener('click', () => {
                createModal.dataset.targetDirectory = finderInstance.currentPath;
                const pasteOption = document.getElementById('item-type').querySelector('option[value="paste"]');
                if (pasteOption) { pasteOption.disabled = !systemData.clipboard; }
                createModal.classList.add('active');
            });
            document.getElementById('confirm-create').onclick = async () => {
                const type = document.getElementById('item-type').value;
                const name = document.getElementById('item-name').value.trim();
                const targetDirectoryId = createModal.dataset.targetDirectory;
                if (type === 'paste') {
                    if (systemData.clipboard) {
                        const originalItem = systemData.clipboard;
                        if (systemState.clipboardAction === 'cut' && originalItem.parentId === targetDirectoryId) {
                            axonAlert("Não é possível colar um item em sua própria pasta de origem ao recortar.", "Erro de Colar");
                            systemData.clipboard = null; systemState.clipboardAction = null; closeModal('create-modal'); return;
                        }
                        await AxonAPI.copyItem(originalItem, targetDirectoryId, systemState.clipboardAction === 'cut');
                        systemData.clipboard = null; systemState.clipboardAction = null;
                    } else { axonAlert("Nenhum item para colar na área de transferência."); }
                } else {
                    if (!name) { await axonAlert("Por favor, digite um nome para o item."); return; }
                    AxonAPI.createFileItem(targetDirectoryId, type, name);
                }
                closeModal('create-modal');
            };
            navigateToDirectory(finderInstance.currentPath);
        }

        function initNotepad(windowElement) {
            const saveBtn = windowElement.querySelector('#save-note');
            const newBtn = windowElement.querySelector('#new-note');
            const openBtn = windowElement.querySelector('#open-note');
            const textArea = windowElement.querySelector('#note-content');
            textArea.focus();
            textArea.addEventListener('input', () => { AxonAPI.logActivity(`Conteúdo do documento de texto alterado para: "${textArea.value.substring(0, 100)}..."`); });
            saveBtn.addEventListener('click', async () => {
                const fileId = textArea.dataset.fileId; const parentId = textArea.dataset.parentId;
                if (fileId && parentId) {
                    const file = findFileInFileSystem(fileId, parentId);
                    if (file && file.type === 'text') {
                        file.content = textArea.value; saveDesktopItems(); await axonAlert(`Arquivo salvo com sucesso!`);
                        AxonAPI.logActivity(`Documento "${file.name}" salvo com o conteúdo: "${file.content.substring(0, 100)}..."`);
                    } else { await axonAlert("Erro: Arquivo não encontrado para salvar. Tente salvar como um novo arquivo."); }
                } else {
                    const activeFinderWindow = systemState.openWindows.find(w => w.id === 'finder' && w.element.classList.contains('active'));
                    const targetDirectoryId = activeFinderWindow ? activeFinderWindow.currentPath : 'axon/desktop';
                    const fileName = await axonPrompt("Digite o nome do arquivo:", "Sem título.txt");
                    if (fileName) {
                        const newFile = AxonAPI.createDocument(fileName, textArea.value, targetDirectoryId);
                        if (newFile) {
                            textArea.dataset.fileId = newFile.id; textArea.dataset.parentId = newFile.parentId;
                            await axonAlert(`Arquivo "${fileName}" salvo com sucesso em ${targetDirectoryId}!`);
                        }
                    }
                }
            });
            newBtn.addEventListener('click', async () => {
                const confirmNew = await axonConfirm('Deseja criar uma nova nota? O conteúdo atual será perdido.');
                if (confirmNew) { textArea.value = ''; textArea.dataset.fileId = ''; textArea.dataset.parentId = ''; textArea.focus(); AxonAPI.logActivity(`Nova nota criada no Bloco de Notas.`); }
            });
            openBtn.addEventListener('click', () => { showOpenFileModal(textArea); });
        }

        function showOpenFileModal(targetTextArea) {
            const fileList = document.getElementById('file-list'); fileList.innerHTML = ''; systemState.selectedFile = null;
            const allTextAndImageFiles = [];
            for (const dirId in systemData.fileSystem) {
                const dir = systemData.fileSystem[dirId];
                if (dir && dir.children) {
                    dir.children.forEach(file => {
                        if (file.type === 'text' || (file.type === 'image' && file.src)) { allTextAndImageFiles.push(file); }
                    });
                }
            }
            allTextAndImageFiles.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item'; fileItem.style.width = '100%';
                fileItem.style.flexDirection = 'row'; fileItem.style.alignItems = 'center';
                fileItem.style.gap = '10px'; fileItem.style.padding = '10px';
                fileItem.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                fileItem.dataset.fileId = file.id; fileItem.dataset.parentId = file.parentId;
                fileItem.tabIndex = 0;
                fileItem.innerHTML = `
                    <div><i class="${fileIcons[file.type] || 'fas fa-file'}"></i></div>
                    <div>${file.name} <span style="font-size: 10px; opacity: 0.7;">(${file.path})</span></div>
                `;
                fileItem.addEventListener('click', () => {
                    document.querySelectorAll('#file-list .file-item').forEach(item => { item.classList.remove('selected'); });
                    fileItem.classList.add('selected'); systemState.selectedFile = file;
                });
                fileList.appendChild(fileItem);
            });
            document.getElementById('confirm-open-file').onclick = async () => {
                if (systemState.selectedFile) {
                    if (systemState.selectedFile.type === 'text' && targetTextArea) {
                        targetTextArea.value = systemState.selectedFile.content || '';
                        targetTextArea.dataset.fileId = systemState.selectedFile.id;
                        targetTextArea.dataset.parentId = systemState.selectedFile.parentId;
                        openFileModal.classList.remove('active');
                        AxonAPI.logActivity(`Documento "${systemState.selectedFile.name}" aberto no Bloco de Notas.`);
                    } else if (systemState.selectedFile.type === 'image') {
                        openImageViewer(systemState.selectedFile.src, systemState.selectedFile.path);
                        openFileModal.classList.remove('active');
                        AxonAPI.logActivity(`Imagem "${systemState.selectedFile.name}" aberta no Visualizador de Imagens.`);
                    } else { await axonAlert("Tipo de arquivo não suportado para esta ação."); }
                    systemState.selectedFile = null;
                } else { await axonAlert("Por favor, selecione um arquivo."); }
            };
            document.getElementById('cancel-open-file').onclick = () => { openFileModal.classList.remove('active'); systemState.selectedFile = null; };
            openFileModal.classList.add('active');
        }

        function initTerminal(windowElement) {
            const terminalContent = windowElement.querySelector('#terminal-content');
            const terminalInput = windowElement.querySelector('#terminal-input');
            terminalInput.focus();
            terminalContent.innerHTML = '';
            systemState.terminalHistory.forEach(item => {
                terminalContent.innerHTML += `<div class="prompt">axon@os:${item.path || systemState.currentPath}$ <span class="command">${item.command}</span></div>`;
                if (item.output) { terminalContent.innerHTML += `<div>${item.output}</div>`; }
            });
            terminalContent.scrollTop = terminalContent.scrollHeight;
            terminalInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const command = terminalInput.value.trim();
                    if (command) {
                        terminalContent.innerHTML += `<div class="prompt">axon@os:${systemState.currentPath}$ <span class="command">${command}</span></div>`;
                        let output = processCommand(command);
                        if (output) { terminalContent.innerHTML += `<div>${output}</div>`; }
                        terminalInput.value = ''; terminalContent.scrollTop = terminalContent.scrollHeight;
                        systemState.terminalHistory.push({ command, output, path: systemState.currentPath });
                        AxonAPI.logActivity(`Comando do terminal executado: "${command}"`);
                    }
                }
            });
        }

        function processCommand(command) {
            const cmd = command.split(' ')[0].toLowerCase();
            const args = command.split(' ').slice(1);
            switch(cmd) {
                case 'help': return "Comandos disponíveis: ls, cd, mkdir, touch, echo, clear, date, help";
                case 'ls':
                    const currentDir = getDirectoryById(systemState.currentPath);
                    if (!currentDir || !currentDir.children || currentDir.children.length === 0) return "Diretório vazio.";
                    return currentDir.children.map(item => {
                        const icon = fileIcons[item.type] || 'fas fa-file';
                        return `<i class="${icon}"></i> ${item.name}`;
                    }).join('<br>');
                case 'cd':
                    const targetDirName = args[0];
                    if (!targetDirName) return "Uso: cd <diretório>";
                    if (targetDirName === '..') {
                        const pathParts = systemState.currentPath.split('/');
                        if (pathParts.length > 1) {
                            pathParts.pop(); systemState.currentPath = pathParts.join('/');
                            if (systemState.currentPath === '') systemState.currentPath = 'axon';
                            return `Diretório alterado para: ${systemState.currentPath}`;
                        } else { return "Já está no diretório raiz (axon)."; }
                    } else {
                        const currentDir = getDirectoryById(systemState.currentPath);
                        const targetItem = currentDir.children.find(item => item.name === targetDirName && item.type === 'folder');
                        if (targetItem) { systemState.currentPath = targetItem.id; return `Diretório alterado para: ${systemState.currentPath}`; }
                        else { return `Diretório não encontrado ou não é uma pasta: ${targetDirName}`; }
                    }
                case 'mkdir':
                    const newFolderName = args[0];
                    if (newFolderName) {
                        const newFolder = createFileItem(systemState.currentPath, 'folder', newFolderName);
                        if (newFolder) { updateFileInterfaces(); return `Diretório criado: ${newFolderName}`; }
                        else { return `Erro ao criar diretório: ${newFolderName}`; }
                    }
                    return "Uso: mkdir <nome_da_pasta>";
                case 'touch':
                    const newFileName = args[0];
                    if (newFileName) {
                        const newFile = createFileItem(systemState.currentPath, 'text', newFileName);
                        if (newFile) { updateFileInterfaces(); return `Arquivo criado: ${newFileName}`; }
                        else { return `Erro ao criar arquivo: ${newFileName}`; }
                    }
                    return "Uso: touch <nome_do_arquivo>";
                case 'echo': return args.join(' ');
                case 'clear':
                    const terminalContent = document.querySelector('#terminal-content');
                    if (terminalContent) terminalContent.innerHTML = ''; return "";
                case 'date':
                    const now = new Date();
                    return now.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                default: return `Comando não encontrado: ${cmd}. Digite 'help' para ver os comandos disponíveis.`;
            }
        }

        function initMielina(windowElement) {
            const chatMessages = windowElement.querySelector('#chat-messages');
            const chatInput = windowElement.querySelector('#chat-input');
            const sendButton = windowElement.querySelector('#send-message');
            chatInput.focus();
            systemState.chatHistory.forEach(msg => {
                if (msg.role === "user" && msg.parts[0].text.includes("Você é a Mielina")) return;
                const messageElement = document.createElement('div');
                messageElement.className = `message ${msg.role === 'user' ? 'user-message' : 'assistant-message'}`;
                messageElement.textContent = msg.parts[0].text;
                chatMessages.appendChild(messageElement);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
            async function sendMessage() {
                const message = chatInput.value.trim();
                if (message) {
                    const userMessageElement = document.createElement('div');
                    userMessageElement.className = 'message user-message';
                    userMessageElement.textContent = message;
                    chatMessages.appendChild(userMessageElement);
                    systemState.chatHistory.push({ role: 'user', parts: [{ text: message }] });
                    chatInput.value = ''; chatInput.disabled = true; sendButton.disabled = true;
                    const typingIndicator = document.createElement('div');
                    typingIndicator.className = 'message assistant-message';
                    typingIndicator.textContent = 'Mielina está digitando...';
                    chatMessages.appendChild(typingIndicator); chatMessages.scrollTop = chatMessages.scrollHeight;
                    aiApiBadge.style.display = 'inline-block';
                    let responseText = "Desculpe, não consegui me conectar com a Mielina no momento. Por favor, tente novamente mais tarde.";
                    let modelUsed = "Nenhum";
                    for (const model of GEMINI_MODELS) {
                        try {
                            const response = await getGeminiResponse(systemState.chatHistory, model);
                            responseText = response.text; modelUsed = response.model; break;
                        } catch (error) {
                            console.error(`Erro ao obter resposta da Gemini com o modelo ${model}:`, error);
                            responseText = `Falha ao conectar com o modelo ${model}. Tentando o próximo...`;
                        }
                    }
                    chatMessages.removeChild(typingIndicator);
                    const assistantMessageElement = document.createElement('div');
                    assistantMessageElement.className = 'message assistant-message';
                    assistantMessageElement.textContent = responseText;
                    chatMessages.appendChild(assistantMessageElement);
                    systemState.chatHistory.push({ role: 'model', parts: [{ text: responseText }] });
                    if (modelUsed !== "Nenhum") {
                        const modelInfoElement = document.createElement('div');
                        modelInfoElement.className = 'message assistant-message';
                        modelInfoElement.style.fontSize = '10px'; modelInfoElement.style.opacity = '0.7';
                        modelInfoElement.textContent = `(Modelo utilizado: ${modelUsed})`;
                        chatMessages.appendChild(modelInfoElement);
                    } else {
                        const modelInfoElement = document.createElement('div');
                        modelInfoElement.className = 'message assistant-message';
                        modelInfoElement.style.fontSize = '10px'; modelInfoElement.style.opacity = '0.7';
                        modelInfoElement.textContent = `(Falha em todos os modelos. Verifique sua conexão ou chave de API.)`;
                        chatMessages.appendChild(modelInfoElement);
                    }
                    chatInput.disabled = false; sendButton.disabled = false;
                    chatMessages.scrollTop = chatMessages.scrollHeight; chatInput.focus();
                    aiApiBadge.style.display = 'none';
                }
            }
            sendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
        }

        async function getGeminiResponse(chatHistory, model) {
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
            const payload = { contents: chatHistory.map(msg => ({ role: msg.role, parts: msg.parts })) };
            const response = await fetch(GEMINI_API_URL, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Erro HTTP: ${response.status} - ${errorData.error.message || response.statusText}`);
            }
            const data = await response.json();
            if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0) {
                let mielinaResponse = data.candidates[0].content.parts[0].text;
                const apiCallRegex = /AxonAPI\.(\w+)\(([^)]*)\)/g;
                let match; let apiCalls = [];
                while ((match = apiCallRegex.exec(mielinaResponse)) !== null) {
                    try { apiCalls.push({ func: match[1], args: JSON.parse(`[${match[2]}]`) }); }
                    catch (e) { AxonAPI.debug(`Erro ao parsear argumentos da API: ${match[2]} - ${e.message}`); }
                }
                if (apiCalls.length > 0) {
                    for (const call of apiCalls) {
                        if (typeof AxonAPI[call.func] === 'function') {
                            try {
                                const apiResult = await AxonAPI[call.func](...call.args);
                                mielinaResponse += `\n\nComando "${call.func}" executado. Resultado: ${JSON.stringify(apiResult).substring(0, 100)}...`;
                            } catch (e) {
                                mielinaResponse += `\n\nErro ao executar "${call.func}": ${e.message}`;
                            }
                        } else { mielinaResponse += `\n\nComando "${call.func}" não reconhecido.`; }
                    }
                }
                return { text: mielinaResponse, model: model };
            } else { throw new Error("Resposta da Gemini sem conteúdo esperado."); }
        }

        function initCalculator(windowElement) {
            const display = windowElement.querySelector('#calc-display');
            const buttons = windowElement.querySelectorAll('.calc-btn');
            let currentInput = '0'; let previousInput = ''; let operation = null; let resetDisplay = false;
            function updateDisplay() { display.textContent = currentInput; }
            function handleNumberInput(value) {
                if (resetDisplay) { currentInput = '0'; resetDisplay = false; }
                if (value === 'decimal') { if (!currentInput.includes('.')) { currentInput += '.'; } }
                else { if (currentInput === '0') { currentInput = value; } else { currentInput += value; } }
                AxonAPI.logActivity(`Calculadora: Entrada de número "${value}"`);
            }
            function handleOperation(op) {
                if (op === 'clear') { currentInput = '0'; previousInput = ''; operation = null; resetDisplay = false; AxonAPI.logActivity(`Calculadora: Limpar`); return; }
                if (op === 'backspace') { currentInput = currentInput.slice(0, -1) || '0'; AxonAPI.logActivity(`Calculadora: Backspace`); return; }
                if (op === 'percent') { currentInput = (parseFloat(currentInput) / 100).toString(); AxonAPI.logActivity(`Calculadora: Porcentagem`); return; }
                if (previousInput !== '' && operation && !resetDisplay) { calculate(); }
                operation = op; previousInput = currentInput; resetDisplay = true;
                AxonAPI.logActivity(`Calculadora: Operação "${op}"`);
            }
            function calculate() {
                const prev = parseFloat(previousInput); const current = parseFloat(currentInput);
                if (isNaN(prev) || isNaN(current)) return;
                let result;
                switch(operation) {
                    case 'add': result = prev + current; break;
                    case 'subtract': result = prev - current; break;
                    case 'multiply': result = prev * current; break;
                    case 'divide':
                        if (current === 0) { axonAlert("Divisão por zero não é permitida."); result = 'Erro'; }
                        else { result = prev / current; }
                        break;
                    default: return;
                }
                currentInput = result.toString(); operation = null; previousInput = ''; resetDisplay = true;
                AxonAPI.logActivity(`Calculadora: Resultado "${result}"`);
            }
            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    const action = button.dataset.action;
                    if (!isNaN(action) || action === 'decimal') { handleNumberInput(action); }
                    else if (action === 'equals') { calculate(); resetDisplay = true; }
                    else { handleOperation(action); }
                    updateDisplay();
                });
            });
            updateDisplay();
        }

        function initGallery(windowElement) {
            const galleryContainer = windowElement.querySelector('#gallery-container');
            function loadGallery() {
                galleryContainer.innerHTML = '';
                const allImages = [];
                const imagesDir = getDirectoryById('axon/images');
                if (imagesDir && imagesDir.children) {
                    imagesDir.children.forEach(file => {
                        if (file.type === 'image' && file.src) { allImages.push(file); }
                    });
                }
                allImages.forEach((photo, index) => {
                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'gallery-item'; galleryItem.dataset.id = photo.id;
                    galleryItem.dataset.src = photo.src; galleryItem.dataset.path = photo.path;
                    galleryItem.innerHTML = `
                        <img src="${photo.src}" alt="${photo.name}">
                        <div class="gallery-options">
                            <button class="gallery-option-btn" data-action="view"><i class="fas fa-eye"></i></button>
                            <button class="gallery-option-btn" data-action="delete"><i class="fas fa-trash"></i></button>
                            <button class="gallery-option-btn" data-action="copy"><i class="fas fa-copy"></i></button>
                        </div>
                    `;
                    galleryItem.querySelector('[data-action="view"]').addEventListener('click', (e) => {
                        e.stopPropagation(); openImageViewer(photo.src, photo.path);
                        AxonAPI.logActivity(`Visualizou imagem "${photo.name}" na Galeria.`);
                    });
                    galleryItem.querySelector('[data-action="delete"]').addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const confirmDelete = await axonConfirm("Tem certeza que deseja excluir esta imagem?");
                        if (confirmDelete) { AxonAPI.deleteFileItem(photo.id, photo.parentId); axonAlert("Imagem excluída com sucesso!"); }
                    });
                    galleryItem.querySelector('[data-action="copy"]').addEventListener('click', (e) => {
                        e.stopPropagation(); systemData.clipboard = { ...photo, name: `Cópia de ${photo.name}` };
                        systemState.clipboardAction = 'copy'; axonAlert(`"${photo.name}" copiada para a área de transferência.`);
                        AxonAPI.logActivity(`Copiou imagem "${photo.name}" para a área de transferência.`);
                    });
                    galleryContainer.appendChild(galleryItem);
                });
            }
            loadGallery();
        }

        function openImageViewer(src, path) {
            const viewerModal = document.getElementById('image-viewer-modal');
            const viewerImg = document.getElementById('image-viewer-img');
            const viewerPath = document.getElementById('image-viewer-path');
            viewerImg.src = src; viewerPath.textContent = path; viewerModal.classList.add('active');
        }

        async function initCamera(windowElement) {
            const cameraPreview = windowElement.querySelector('#camera-preview');
            const captureBtn = windowElement.querySelector('#capture-btn');
            if (systemState.cameraStream) { systemState.cameraStream.getTracks().forEach(track => track.stop()); systemState.cameraStream = null; }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                systemState.cameraStream = stream;
                const video = document.createElement('video');
                video.srcObject = stream; video.autoplay = true;
                video.style.width = '100%'; video.style.height = '100%';
                cameraPreview.innerHTML = ''; cameraPreview.appendChild(video);
                captureBtn.addEventListener('click', async () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const photoData = canvas.toDataURL('image/png');
                    const imagesDir = getDirectoryById('axon/images');
                    if (imagesDir) {
                        const photoName = `Foto ${new Date().toLocaleString()}.png`;
                        const newImage = AxonAPI.createFileItem('axon/images', 'image', photoName, '', photoData);
                        if (newImage) { await axonAlert('Foto capturada com sucesso e salva em axon/images!'); AxonAPI.logActivity(`Foto capturada e salva como "${photoName}"`); }
                    } else { await axonAlert("Erro: Diretório 'axon/images' não encontrado."); }
                });
            } catch (err) {
                console.error('Erro ao acessar a câmera:', err);
                cameraPreview.innerHTML = '<p>Não foi possível acessar a câmera. Verifique as permissões.</p>';
                await axonAlert('Não foi possível acessar a câmera. Verifique as permissões do navegador.', 'Erro de Câmera');
                AxonAPI.logActivity(`Erro ao acessar a câmera: ${err.message}`);
            }
        }

        function initBrowser(windowElement) {
            const browserUrl = windowElement.querySelector('#browser-url');
            const browserGo = windowElement.querySelector('#browser-go');
            const browserContent = windowElement.querySelector('#browser-content');
            const browserBack = windowElement.querySelector('#browser-back');
            const browserForward = windowElement.querySelector('#browser-forward');
            const browserReload = windowElement.querySelector('#browser-reload');
            const browserHome = windowElement.querySelector('#browser-home');
            let history = []; let historyIndex = -1;
            browserUrl.focus();
            function loadUrl(url) {
                try {
                    if (!url.match(/^(https?:\/\/|file:\/\/|data:)/)) { url = 'https://' + url; }
                    browserContent.src = url;
                    if (historyIndex < history.length - 1) { history = history.slice(0, historyIndex + 1); }
                    history.push(url); historyIndex = history.length - 1; browserUrl.value = url;
                    AxonAPI.logActivity(`Navegador: Carregou URL "${url}"`);
                } catch (e) {
                    browserContent.srcdoc = `<html><body><p>Não foi possível carregar o site: ${url}</p><p>Isso pode ocorrer devido a restrições de segurança (X-Frame-Options) ou URL inválida.</p></body></html>`;
                    AxonAPI.logActivity(`Navegador: Erro ao carregar URL "${url}": ${e.message}`);
                }
            }
            loadUrl(browserUrl.value);
            browserGo.addEventListener('click', () => { loadUrl(browserUrl.value); });
            browserUrl.addEventListener('keypress', (e) => { if (e.key === 'Enter') { loadUrl(browserUrl.value); } });
            browserBack.addEventListener('click', () => {
                if (historyIndex > 0) { historyIndex--; browserContent.src = history[historyIndex]; browserUrl.value = history[historyIndex]; AxonAPI.logActivity(`Navegador: Voltou para "${history[historyIndex]}"`); }
            });
            browserForward.addEventListener('click', () => {
                if (historyIndex < history.length - 1) { historyIndex++; browserContent.src = history[historyIndex]; browserUrl.value = history[historyIndex]; AxonAPI.logActivity(`Navegador: Avançou para "${history[historyIndex]}"`); }
            });
            browserReload.addEventListener('click', () => { browserContent.contentWindow.location.reload(); AxonAPI.logActivity(`Navegador: Recarregou a página.`); });
            browserHome.addEventListener('click', () => { loadUrl('https://www.google.com'); AxonAPI.logActivity(`Navegador: Voltou para a página inicial.`); });
        }

        function initSettings(windowElement) {
            const tabs = windowElement.querySelectorAll('#settings-tabs .tab');
            const tabContents = windowElement.querySelectorAll('.settings-tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active')); tabContents.forEach(tc => tc.classList.remove('active'));
                    tab.classList.add('active'); document.getElementById(`settings-${tab.dataset.tab}`).classList.add('active');
                    AxonAPI.logActivity(`Configurações: Abriu a aba "${tab.dataset.tab}"`);
                });
            });
            const themeSelect = windowElement.querySelector('#theme-select');
            const wallpaperOptions = windowElement.querySelectorAll('.wallpaper-option');
            const animationsToggle = windowElement.querySelector('#animations-toggle');
            const transparencyToggle = windowElement.querySelector('#transparency-toggle');
            const particlesToggle = windowElement.querySelector('#particles-toggle');
            themeSelect.value = systemData.settings.theme;
            wallpaperOptions.forEach(opt => {
                if (opt.dataset.wallpaper === systemData.settings.wallpaper) { opt.classList.add('selected'); }
                else { opt.classList.remove('selected'); }
            });
            animationsToggle.checked = systemData.settings.animations;
            transparencyToggle.checked = systemData.settings.transparency;
            particlesToggle.checked = systemData.settings.particles;
            themeSelect.addEventListener('change', () => {
                const oldTheme = systemData.settings.theme; systemData.settings.theme = themeSelect.value;
                applySettings(); saveSettings();
                AxonAPI.logActivity(`Configurações: Tema alterado de "${oldTheme}" para "${systemData.settings.theme}"`);
            });
            wallpaperOptions.forEach(opt => {
                opt.addEventListener('click', () => {
                    const oldWallpaper = systemData.settings.wallpaper;
                    wallpaperOptions.forEach(o => o.classList.remove('selected')); opt.classList.add('selected');
                    systemData.settings.wallpaper = opt.dataset.wallpaper; applySettings(); saveSettings();
                    AxonAPI.logActivity(`Configurações: Papel de parede alterado de "${oldWallpaper}" para "${systemData.settings.wallpaper}"`);
                });
            });
            animationsToggle.addEventListener('change', () => {
                systemData.settings.animations = animationsToggle.checked; applySettings(); saveSettings();
                AxonAPI.logActivity(`Configurações: Animações ${systemData.settings.animations ? 'habilitadas' : 'desabilitadas'}`);
            });
            transparencyToggle.addEventListener('change', () => {
                systemData.settings.transparency = transparencyToggle.checked; applySettings(); saveSettings();
                AxonAPI.logActivity(`Configurações: Transparências ${systemData.settings.transparency ? 'habilitadas' : 'desabilitadas'}`);
            });
            particlesToggle.addEventListener('change', () => {
                systemData.settings.particles = particlesToggle.checked; applySettings(); saveSettings();
                AxonAPI.logActivity(`Configurações: Efeitos de partículas ${systemData.settings.particles ? 'habilitados' : 'desabilitados'}`);
            });
            const loginEnabledToggle = windowElement.querySelector('#login-enabled-toggle');
            const setCredentialsBtn = windowElement.querySelector('#set-credentials-btn');
            const firewallToggle = windowElement.querySelector('#firewall-toggle');
            loginEnabledToggle.checked = systemData.settings.loginEnabled;
            loginEnabledToggle.addEventListener('change', () => {
                systemData.settings.loginEnabled = loginEnabledToggle.checked; saveSettings();
                axonAlert(`Login do sistema ${loginEnabledToggle.checked ? 'habilitado' : 'desabilitado'}.`, "Segurança");
                AxonAPI.logActivity(`Configurações: Login do sistema ${systemData.settings.loginEnabled ? 'habilitado' : 'desabilitado'}`);
            });
            setCredentialsBtn.addEventListener('click', async () => {
                const newUsername = await axonPrompt("Digite o novo nome de usuário:", systemData.settings.username || "admin", "Definir Credenciais");
                if (newUsername === null) return;
                const newPassword = await axonPrompt("Digite a nova senha:", "", "Definir Credenciais");
                if (newPassword === null) return;
                systemData.settings.username = newUsername; systemData.settings.password = newPassword;
                saveSettings(); axonAlert("Credenciais de login atualizadas com sucesso!", "Segurança");
                AxonAPI.logActivity(`Configurações: Credenciais de login atualizadas.`);
            });
            firewallToggle.addEventListener('change', async (e) => {
                await axonAlert(`Firewall ${e.target.checked ? 'ativado' : 'desativado'}. (Funcionalidade simulada)`, "Segurança");
                AxonAPI.logActivity(`Configurações: Firewall ${e.target.checked ? 'ativado' : 'desativado'}`);
            });
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('axon-settings');
            if (savedSettings) { Object.assign(systemData.settings, JSON.parse(savedSettings)); }
        }

        function saveSettings() { localStorage.setItem('axon-settings', JSON.stringify(systemData.settings)); }

        function applySettings() {
            const root = document.documentElement; const body = document.body;
            const particlesCanvas = document.getElementById('particles'); const gridBg = document.querySelector('.grid-bg');
            switch (systemData.settings.theme) {
                case 'axon-dark':
                    root.style.setProperty('--primary', '#0c0c1d'); root.style.setProperty('--secondary', '#1a1a3a');
                    root.style.setProperty('--accent', '#6a5af9'); root.style.setProperty('--text', '#e6e6ff');
                    root.style.setProperty('--card-bg', 'rgba(30, 30, 50, 0.7)'); root.style.setProperty('--glass', 'rgba(40, 40, 60, 0.3)');
                    root.style.setProperty('--accent-light', '#7d6dfa'); root.style.setProperty('--highlight', 'rgba(106, 90, 249, 0.2)');
                    break;
                case 'axon-light':
                    root.style.setProperty('--primary', '#f0f0f5'); root.style.setProperty('--secondary', '#e0e0e5');
                    root.style.setProperty('--accent', '#4a3af9'); root.style.setProperty('--text', '#1a1a1a');
                    root.style.setProperty('--card-bg', 'rgba(255, 255, 255, 0.8)'); root.style.setProperty('--glass', 'rgba(255, 255, 255, 0.5)');
                    root.style.setProperty('--accent-light', '#5c4af9'); root.style.setProperty('--highlight', 'rgba(74, 58, 249, 0.1)');
                    break;
                case 'terminal-green':
                    root.style.setProperty('--primary', '#000000'); root.style.setProperty('--secondary', '#0a0a0a');
                    root.style.setProperty('--accent', '#00ff00'); root.style.setProperty('--text', '#00ff00');
                    root.style.setProperty('--card-bg', 'rgba(0, 20, 0, 0.8)'); root.style.setProperty('--glass', 'rgba(0, 30, 0, 0.5)');
                    root.style.setProperty('--accent-light', '#33ff33'); root.style.setProperty('--highlight', 'rgba(0, 255, 0, 0.1)');
                    break;
                case 'purple-haze':
                    root.style.setProperty('--primary', '#2a0a3a'); root.style.setProperty('--secondary', '#3a1a4a');
                    root.style.setProperty('--accent', '#d66efd'); root.style.setProperty('--text', '#f0e0ff');
                    root.style.setProperty('--card-bg', 'rgba(40, 10, 50, 0.7)'); root.style.setProperty('--glass', 'rgba(50, 20, 60, 0.3)');
                    root.style.setProperty('--accent-light', '#e67eff'); root.style.setProperty('--highlight', 'rgba(214, 110, 253, 0.2)');
                    break;
            }
            switch (systemData.settings.wallpaper) {
                case 'default': body.style.background = 'radial-gradient(circle at center, var(--primary), var(--secondary))'; break;
                case 'gradient1': body.style.background = 'linear-gradient(135deg, #6a5af9, #d66efd)'; break;
                case 'gradient2': body.style.background = 'linear-gradient(135deg, #00cc88, #00b4ff)'; break;
            }
            if (!systemData.settings.animations) {
                const style = document.createElement('style'); style.id = 'no-transitions-style';
                style.innerHTML = `* { transition: none !important; }`; document.head.appendChild(style);
            } else { const existingStyle = document.getElementById('no-transitions-style'); if (existingStyle) { existingStyle.remove(); } }
            const elementsWithGlass = document.querySelectorAll('.window, #dock, #menu-bar, .custom-modal-content, .modal-content, .login-box');
            if (systemData.settings.transparency) {
                elementsWithGlass.forEach(el => { el.style.backdropFilter = 'blur(10px)'; el.style.webkitBackdropFilter = 'blur(10px)'; });
            } else { elementsWithGlass.forEach(el => { el.style.backdropFilter = 'none'; el.style.webkitBackdropFilter = 'none'; }); }
            if (systemData.settings.particles) { particlesCanvas.style.display = 'block'; gridBg.style.display = 'block'; }
            else { particlesCanvas.style.display = 'none'; gridBg.style.display = 'none'; }
        }

        function setupWindowEvents(windowElement, appId, windowId) {
            const closeBtn = windowElement.querySelector('.window-close');
            const minimizeBtn = windowElement.querySelector('.window-minimize');
            const maximizeBtn = windowElement.querySelector('.window-maximize');
            closeBtn.addEventListener('click', () => AxonAPI.closeWindow(windowId));
            minimizeBtn.addEventListener('click', () => AxonAPI.minimizeWindow(windowId));
            maximizeBtn.addEventListener('click', () => AxonAPI.toggleMaximizeWindow(windowId));
            const header = windowElement.querySelector('.window-header');
            let isDraggingWindow = false; let offsetX, offsetY;
            header.addEventListener('mousedown', dragMouseDown);
            function dragMouseDown(e) {
                if (e.button === 0 && !windowElement.classList.contains('maximized')) {
                    e.preventDefault(); bringToFront(windowId); isDraggingWindow = true;
                    offsetX = e.clientX - windowElement.getBoundingClientRect().left;
                    offsetY = e.clientY - windowElement.getBoundingClientRect().top;
                    windowElement.style.cursor = 'grabbing';
                    document.addEventListener('mousemove', elementDrag);
                    document.addEventListener('mouseup', closeDragElement);
                }
            }
            function elementDrag(e) {
                if (!isDraggingWindow) return;
                let newX = e.clientX - offsetX; let newY = e.clientY - offsetY;
                const menuBarHeight = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--menu-bar-height'));
                newY = Math.max(menuBarHeight, newY);
                windowElement.style.left = `${newX}px`; windowElement.style.top = `${newY}px`;
            }
            function closeDragElement() {
                isDraggingWindow = false; windowElement.style.cursor = 'grab';
                document.removeEventListener('mousemove', elementDrag);
                document.removeEventListener('mouseup', closeDragElement);
                AxonAPI.logActivity(`Janela "${windowElement.id}" arrastada.`);
            }
            windowElement.addEventListener('mousedown', () => { bringToFront(windowId); });
        }

        function closeWindow(windowId) {
            const windowElement = document.getElementById(windowId);
            if (windowElement) {
                windowElement.classList.remove('active');
                setTimeout(() => {
                    const app = systemState.openWindows.find(w => w.windowId === windowId);
                    if (app && app.id === 'camera' && systemState.cameraStream) {
                        systemState.cameraStream.getTracks().forEach(track => track.stop());
                        systemState.cameraStream = null;
                    }
                    windowElement.remove();
                    systemState.openWindows = systemState.openWindows.filter(w => w.windowId !== windowId);
                    if (systemState.activeWindow === windowId) {
                        if (systemState.openWindows.length > 0) {
                            const highestZWindow = systemState.openWindows.reduce((prev, current) => {
                                const prevZ = parseInt(document.getElementById(prev.windowId)?.style.zIndex || 0);
                                const currentZ = parseInt(document.getElementById(current.windowId)?.style.zIndex || 0);
                                return (prevZ > currentZ) ? prev : current;
                            });
                            systemState.activeWindow = highestZWindow.windowId; bringToFront(systemState.activeWindow);
                        } else { systemState.activeWindow = null; }
                    }
                    showDock(); AxonAPI.logActivity(`Janela "${windowId}" fechada.`);
                }, 300);
            }
        }

        function minimizeWindow(windowId) {
            const windowElement = document.getElementById(windowId);
            if (windowElement) {
                windowElement.classList.remove('active');
                setTimeout(() => {
                    windowElement.style.display = 'none'; showDock();
                    AxonAPI.logActivity(`Janela "${windowId}" minimizada.`);
                }, 300);
            }
        }

        function toggleMaximizeWindow(windowId) {
            const windowElement = document.getElementById(windowId);
            if (windowElement) {
                if (windowElement.classList.contains('maximized')) {
                    windowElement.classList.remove('maximized');
                    windowElement.style.width = ''; windowElement.style.height = '';
                    windowElement.style.left = ''; windowElement.style.top = '';
                    showDock(); AxonAPI.logActivity(`Janela "${windowId}" restaurada.`);
                } else {
                    windowElement.classList.add('maximized'); hideDock();
                    AxonAPI.logActivity(`Janela "${windowId}" maximizada.`);
                }
            }
        }

        function bringToFront(windowId) {
            let maxZIndex = 100;
            systemState.openWindows.forEach(w => {
                const win = document.getElementById(w.windowId);
                if (win) {
                    const currentZ = parseInt(win.style.zIndex) || 100;
                    if (currentZ > maxZIndex) { maxZIndex = currentZ; }
                }
            });
            const targetWindow = document.getElementById(windowId);
            if (targetWindow) {
                targetWindow.style.zIndex = maxZIndex + 1; systemState.activeWindow = windowId;
                targetWindow.style.display = 'flex'; targetWindow.classList.add('active');
            }
        }

        function hideDock() { dock.classList.add('hidden'); }
        function showDock() { dock.classList.remove('hidden'); }

        function showWindowCarousel() {
            const carouselBody = document.getElementById('window-carousel-body'); carouselBody.innerHTML = '';
            if (systemState.openWindows.length === 0) {
                carouselBody.innerHTML = '<p style="text-align: center; width: 100%;">Nenhuma janela aberta.</p>';
                document.getElementById('window-carousel-modal').classList.add('active'); return;
            }
            systemState.openWindows.forEach(win => {
                const thumbnail = document.createElement('div');
                thumbnail.className = 'window-thumbnail'; thumbnail.dataset.windowId = win.windowId;
                thumbnail.innerHTML = `
                    <div class="window-thumbnail-header">
                        <i class="${win.appIcon}"></i> <span class="window-title-text">${win.appName}</span>
                        <div class="close-btn dock-style-button"><i class="fas fa-times"></i></div>
                    </div>
                    <div class="window-thumbnail-content">
                        <i class="${win.appIcon}"></i>
                    </div>
                `;
                thumbnail.addEventListener('click', (e) => {
                    if (!e.target.closest('.close-btn')) {
                        bringToFront(win.windowId); closeModal('window-carousel-modal');
                        AxonAPI.logActivity(`Janela "${win.appName}" selecionada no carrossel.`);
                    }
                });
                thumbnail.querySelector('.close-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); AxonAPI.closeWindow(win.windowId); thumbnail.remove();
                    if (systemState.openWindows.length === 0) { carouselBody.innerHTML = '<p style="text-align: center; width: 100%;">Nenhuma janela aberta.</p>'; }
                });
                carouselBody.appendChild(thumbnail);
            });
            document.getElementById('window-carousel-modal').classList.add('active');
            AxonAPI.logActivity(`Carrossel de janelas aberto.`);
        }

        function createParticles() {
            const canvas = document.getElementById('particles'); const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            const particles = []; const particleCount = 100;
            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    x: Math.random() * canvas.width, y: Math.random() * canvas.height,
                    radius: Math.random() * 2 + 1, speedX: (Math.random() - 0.5) * 0.5,
                    speedY: (Math.random() - 0.5) * 0.5, color: `rgba(106, 90, 249, ${Math.random() * 0.5 + 0.1})`
                });
            }
            function drawParticles() {
                if (!systemData.settings.particles) { return; }
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => {
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fillStyle = p.color; ctx.fill();
                    p.x += p.speedX; p.y += p.speedY;
                    if (p.x < 0 || p.x > canvas.width) p.speedX *= -1;
                    if (p.y < 0 || p.y > canvas.height) p.speedY *= -1;
                });
                requestAnimationFrame(drawParticles);
            }
            drawParticles();
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth; canvas.height = window.innerHeight;
                setupDesktopGrid(); loadDesktopItems();
            });
        }

        function showLoginScreen() {
            loginScreen.classList.add('active');
            document.getElementById('menu-bar').style.display = 'none';
            document.getElementById('dock').style.display = 'none';
            document.getElementById('desktop').style.display = 'none';
            document.getElementById('windows-container').style.display = 'none';
            loginUsernameInput.focus();
        }

        function hideLoginScreen() {
            loginScreen.classList.remove('active');
            document.getElementById('menu-bar').style.display = 'flex';
            document.getElementById('dock').style.display = 'flex';
            document.getElementById('desktop').style.display = 'block';
            document.getElementById('windows-container').style.display = 'block';
            loadDesktopItems();
        }

        async function handleLogin() {
            const username = loginUsernameInput.value;
            const password = loginPasswordInput.value;
            if (username === systemData.settings.username && password === systemData.settings.password) {
                hideLoginScreen(); AxonAPI.logActivity(`Login bem-sucedido.`);
            } else {
                await axonAlert("Usuário ou senha incorretos.", "Erro de Login");
                loginPasswordInput.value = ''; loginUsernameInput.focus();
                AxonAPI.logActivity(`Tentativa de login falhou.`);
            }
        }

        async function loadAxonApps() {
            systemState.axonApps = [];
            const axonAppsDir = getDirectoryById('axon/axonapps');
            if (axonAppsDir) { axonAppsDir.children = []; }
            for (let i = 1; i <= 50; i++) {
                const filePath = `apps/app${i}/app.html`;
                try {
                    const response = await fetch(filePath);
                    if (!response.ok) { continue; }
                    const htmlContent = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlContent, 'text/html');
                    const titleElement = doc.querySelector('title');
                    const appName = titleElement ? titleElement.textContent : `App ${i}`;
                    let appIcon = 'fas fa-code';
                    const linkElements = doc.querySelectorAll('link[rel="icon"], link[rel="shortcut icon"]');
                    for (const link of linkElements) { if (link.href) { appIcon = 'fas fa-file-code'; break; } }
                    const appId = `html-app-${appName.replace(/\s+/g, '-').toLowerCase()}-${Date.now()}`;
                    const appItem = {
                        id: appId, name: appName, type: 'html-app', icon: appIcon, path: filePath,
                        minWidth: 800, minHeight: 600, parentId: 'axon/axonapps'
                    };
                    systemState.axonApps.push(appItem);
                    if (axonAppsDir) { axonAppsDir.children.push(appItem); }
                } catch (error) { console.error(`Erro ao processar o aplicativo HTML ${filePath}:`, error); }
            }
            saveDesktopItems();
        }

        function initAxonApps(windowElement) {
            const axonAppsGrid = windowElement.querySelector('#axon-apps-grid'); axonAppsGrid.innerHTML = '';
            if (systemState.axonApps.length === 0) {
                axonAppsGrid.innerHTML = '<p style="text-align: center; width: 100%;">Nenhum aplicativo HTML encontrado na pasta "apps/".</p>'; return;
            }
            systemState.axonApps.forEach(app => {
                const appItemDiv = document.createElement('div');
                appItemDiv.className = 'axon-app-item'; appItemDiv.dataset.appId = app.id;
                appItemDiv.tabIndex = 0;
                appItemDiv.innerHTML = `
                    <div class="icon-image">
                        <i class="${app.icon}"></i>
                    </div>
                    <div class="icon-label">${app.name}</div>
                `;
                appItemDiv.addEventListener('click', () => { openHtmlApp(app.path, app.name, app.icon); });
                axonAppsGrid.appendChild(appItemDiv);
            });
        }

        function openHtmlApp(appPath, appName, appIcon) {
            const windowId = `html-app-window-${Date.now()}`;
            const windowElement = document.createElement('div');
            windowElement.className = 'window'; windowElement.id = windowId;
            windowElement.style.width = `800px`; windowElement.style.height = `600px`;
            const menuBarHeight = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--menu-bar-height'));
            const left = Math.max(0, (window.innerWidth - 800) / 2 + (Math.random() * 100 - 50));
            const top = Math.max(menuBarHeight, (window.innerHeight - 600) / 2 + (Math.random() * 100 - 50));
            windowElement.style.left = `${left}px`; windowElement.style.top = `${top}px`;
            const header = document.createElement('div');
            header.className = 'window-header';
            header.innerHTML = `
                <div class="window-title">
                    <i class="${appIcon}"></i> ${appName}
                </div>
                <div class="window-controls">
                    <div class="window-control window-minimize"><i class="fas fa-minus"></i></div>
                    <div class="window-control window-maximize"><i class="fas fa-square"></i></div>
                    <div class="window-control window-close"><i class="fas fa-times"></i></div>
                </div>
            `;
            windowElement.appendChild(header);
            const content = document.createElement('div');
            content.className = 'window-content'; content.style.padding = '0';
            content.innerHTML = `<iframe src="${appPath}" style="width: 100%; height: 100%; border: none;"></iframe>`;
            windowElement.appendChild(content);
            windowsContainer.appendChild(windowElement);
            void windowElement.offsetWidth; windowElement.classList.add('active');
            systemState.openWindows.push({ id: 'html-app-launcher', windowId: windowId, element: windowElement, appName: appName, appIcon: appIcon });
            systemState.activeWindow = windowId; bringToFront(windowId);
            setupWindowEvents(windowElement, 'html-app-launcher', windowId);
            AxonAPI.logActivity(`Aplicativo HTML "${appName}" aberto.`);
        }

        function getHTMLElementMap() {
            const elements = document.querySelectorAll('[id], [class]');
            const elementMap = {};
            elements.forEach(el => {
                const id = el.id; const classes = Array.from(el.classList);
                const tagName = el.tagName.toLowerCase(); const selector = id ? `#${id}` : (classes.length > 0 ? `.${classes[0]}` : tagName);
                if (id) { elementMap[id] = { tagName: tagName, classes: classes, selector: selector, description: `Elemento com ID '${id}'` }; }
                else if (classes.length > 0) {
                    elementMap[`class-${classes[0]}`] = {
                        tagName: tagName, classes: classes, selector: selector,
                        description: `Primeiro elemento com a classe '${classes[0]}'`
                    };
                }
            });
            elementMap['body'] = { tagName: 'body', classes: [], selector: 'body', description: 'O corpo principal do documento.' };
            elementMap['html'] = { tagName: 'html', classes: [], selector: 'html', description: 'O elemento raiz do documento.' };
            elementMap['head'] = { tagName: 'head', classes: [], selector: 'head', description: 'O cabeçalho do documento.' };
            elementMap['style'] = { tagName: 'style', classes: [], selector: 'style', description: 'Onde os estilos CSS são definidos.' };
            elementMap['script'] = { tagName: 'script', classes: [], selector: 'script', description: 'Onde os scripts JavaScript são definidos.' };
            elementMap['root-variables'] = { tagName: ':root', classes: [], selector: ':root', description: 'Variáveis CSS globais.' };
            return elementMap;
        }

        // --- AxonAPI para Mielina ---
        const AxonAPI = {
            logActivity: function(activity) {
                const timestamp = new Date().toLocaleString();
                systemData.userActivityLog.push({ timestamp, activity });
                console.log(`[LOG] ${timestamp}: ${activity}`);
            },
            openApp: function(appName, initialPath = null) {
                const appId = Object.keys(systemData.apps).find(key => systemData.apps[key].name.toLowerCase() === appName.toLowerCase() || key === appName.toLowerCase());
                if (appId) { this.logActivity(`Mielina: Abrindo aplicativo "${appName}"`); openApp(appId, initialPath); return `Aplicativo "${appName}" aberto.`; }
                else { this.logActivity(`Mielina: Tentou abrir aplicativo desconhecido "${appName}"`); return `Aplicativo "${appName}" não encontrado.`; }
            },
            closeApp: function(appName) {
                const appWindow = systemState.openWindows.find(w => w.appName.toLowerCase() === appName.toLowerCase());
                if (appWindow) { this.logActivity(`Mielina: Fechando aplicativo "${appName}"`); closeWindow(appWindow.windowId); return `Aplicativo "${appName}" fechado.`; }
                else { this.logActivity(`Mielina: Tentou fechar aplicativo não aberto "${appName}"`); return `Aplicativo "${appName}" não está aberto.`; }
            },
            createFolder: function(folderName, path = 'axon/desktop') {
                const newFolder = createFileItem(path, 'folder', folderName);
                if (newFolder) { this.logActivity(`Mielina: Criou a pasta "${folderName}" em "${path}"`); return `Pasta "${folderName}" criada com sucesso em "${path}".`; }
                else { return `Não foi possível criar a pasta "${folderName}" em "${path}".`; }
            },
            createDocument: function(docName, content = '', path = 'axon/desktop') {
                const newDoc = createFileItem(path, 'text', docName, content);
                if (newDoc) { this.logActivity(`Mielina: Criou o documento "${docName}" em "${path}" com conteúdo: "${content.substring(0, 50)}..."`); return `Documento "${docName}" criado com sucesso em "${path}".`; }
                else { return `Não foi possível criar o documento "${docName}" em "${path}".`; }
            },
            changeSetting: function(settingName, value) {
                if (systemData.settings.hasOwnProperty(settingName)) {
                    const oldValue = systemData.settings[settingName]; systemData.settings[settingName] = value;
                    applySettings(); saveSettings();
                    this.logActivity(`Mielina: Alterou a configuração "${settingName}" de "${oldValue}" para "${value}"`);
                    return `Configuração "${settingName}" alterada para "${value}".`;
                } else { this.logActivity(`Mielina: Tentou alterar configuração desconhecida "${settingName}"`); return `Configuração "${settingName}" não encontrada.`; }
            },
            getSystemInfo: function() {
                const info = {
                    openApps: systemState.openWindows.map(w => w.appName),
                    currentDesktopItems: systemData.desktopItems.map(item => item.name),
                    currentPath: systemState.currentPath,
                    settings: { ...systemData.settings, password: '[HIDDEN]' },
                    lastActivities: systemData.userActivityLog.slice(-5)
                };
                this.logActivity(`Mielina: Solicitou informações do sistema.`); return info;
            },
            listDirectory: function(path) {
                const dir = getDirectoryById(path);
                if (dir && dir.children) { this.logActivity(`Mielina: Listou o diretório "${path}"`); return dir.children.map(item => ({ name: item.name, type: item.type, path: item.path })); }
                else { this.logActivity(`Mielina: Tentou listar diretório inválido "${path}"`); return `Diretório "${path}" não encontrado ou não é uma pasta.`; }
            },
            readDocument: function(docName, path = 'axon/documents') {
                const dir = getDirectoryById(path);
                if (dir && dir.children) {
                    const doc = dir.children.find(item => item.name === docName && item.type === 'text');
                    if (doc) { this.logActivity(`Mielina: Leu o documento "${docName}" em "${path}"`); return doc.content; }
                    else { this.logActivity(`Mielina: Tentou ler documento não encontrado "${docName}" em "${path}"`); return `Documento "${docName}" não encontrado em "${path}".`; }
                } else { this.logActivity(`Mielina: Tentou ler documento em diretório inválido "${path}"`); return `Diretório "${path}" não encontrado ou não é uma pasta.`; }
            },
            modifyElement: function(selector, property, value) {
                const element = document.querySelector(selector);
                if (element) {
                    if (property === 'textContent') { element.textContent = value; }
                    else if (property === 'innerHTML') { element.innerHTML = value; }
                    else if (property.startsWith('data-')) { element.setAttribute(property, value); }
                    else { element.style[property] = value; }
                    this.logActivity(`Mielina: Alterou a propriedade "${property}" de "${selector}" para "${value}"`);
                    return `Propriedade "${property}" do elemento "${selector}" alterada para "${value}".`;
                } else { this.logActivity(`Mielina: Tentou modificar elemento HTML não encontrado com seletor "${selector}"`); return `Elemento com seletor "${selector}" não encontrado.`; }
            },
            executeScript: function(scriptCode) {
                try { eval(scriptCode); this.logActivity(`Mielina: Executou script: "${scriptCode.substring(0, 100)}..."`); return `Script executado com sucesso.`; }
                catch (e) { this.logActivity(`Mielina: Erro ao executar script: "${e.message}"`); return `Erro ao executar script: ${e.message}`; }
            },
            createElement: function(parentSelector, tagName, attributes = {}, innerHTML = '') {
                const parentElement = document.querySelector(parentSelector);
                if (parentElement) {
                    const newElement = document.createElement(tagName);
                    for (const key in attributes) { newElement.setAttribute(key, attributes[key]); }
                    newElement.innerHTML = innerHTML; parentElement.appendChild(newElement);
                    this.logActivity(`Mielina: Criou um novo elemento <${tagName}> em "${parentSelector}"`);
                    return `Elemento <${tagName}> criado com sucesso em "${parentSelector}".`;
                } else { this.logActivity(`Mielina: Tentou criar elemento em pai não encontrado: "${parentSelector}"`); return `Elemento pai com seletor "${parentSelector}" não encontrado.`; }
            },
            removeElement: function(selector) {
                const elementToRemove = document.querySelector(selector);
                if (elementToRemove) { elementToRemove.remove(); this.logActivity(`Mielina: Removeu o elemento "${selector}"`); return `Elemento "${selector}" removido com sucesso.`; }
                else { this.logActivity(`Mielina: Tentou remover elemento não encontrado: "${selector}"`); return `Elemento com seletor "${selector}" não encontrado.`; }
            },
            getSystemCode: function() {
                this.logActivity(`Mielina: Solicitou o código-fonte do sistema.`);
                return `<!DOCTYPE html>\n` + document.documentElement.outerHTML;
            },
            getHTMLElementDetails: function(selector) {
                const element = document.querySelector(selector);
                if (element) {
                    const details = {
                        tagName: element.tagName.toLowerCase(), id: element.id, classes: Array.from(element.classList),
                        attributes: {}, styles: {}, textContent: element.textContent.trim().substring(0, 200) + (element.textContent.trim().length > 200 ? '...' : ''),
                        innerHTML: element.innerHTML.trim().substring(0, 200) + (element.innerHTML.trim().length > 200 ? '...' : ''),
                        outerHTML: element.outerHTML.trim().substring(0, 200) + (element.outerHTML.trim().length > 200 ? '...' : '')
                    };
                    for (let i = 0; i < element.attributes.length; i++) { const attr = element.attributes[i]; details.attributes[attr.name] = attr.value; }
                    const computedStyle = window.getComputedStyle(element);
                    for (let i = 0; i < computedStyle.length; i++) { const prop = computedStyle[i]; details.styles[prop] = computedStyle.getPropertyValue(prop); }
                    this.logActivity(`Mielina: Obteve detalhes do elemento "${selector}"`); return details;
                } else { this.logActivity(`Mielina: Tentou obter detalhes de elemento não encontrado: "${selector}"`); return `Elemento com seletor "${selector}" não encontrado.`; }
            },
            takePhoto: async function() {
                const cameraWindow = systemState.openWindows.find(w => w.id === 'camera');
                if (cameraWindow) {
                    const captureBtn = cameraWindow.element.querySelector('#capture-btn');
                    if (captureBtn) { captureBtn.click(); this.logActivity(`Mielina: Acionou a captura de foto no aplicativo Câmera.`); return `Foto capturada com sucesso (se a câmera estiver ativa).`; }
                    else { return `Botão de captura não encontrado no aplicativo Câmera.`; }
                } else { return `Aplicativo Câmera não está aberto.`; }
            },
            calculate: function(expression) {
                const calculatorWindow = systemState.openWindows.find(w => w.id === 'calculator');
                if (calculatorWindow) {
                    const display = calculatorWindow.element.querySelector('#calc-display');
                    const buttons = calculatorWindow.element.querySelectorAll('.calc-btn');
                    function pressButton(action) { const btn = Array.from(buttons).find(b => b.dataset.action === action); if (btn) btn.click(); }
                    for (const char of expression) {
                        if (!isNaN(char) || char === '.') { pressButton(char); }
                        else if (char === '+') { pressButton('add'); } else if (char === '-') { pressButton('subtract'); }
                        else if (char === '*') { pressButton('multiply'); } else if (char === '/') { pressButton('divide'); }
                    }
                    pressButton('equals');
                    this.logActivity(`Mielina: Calculou a expressão "${expression}"`); return `Resultado do cálculo: ${display.textContent}`;
                } else { return `Aplicativo Calculadora não está aberto.`; }
            },
            typeInNotepad: function(text) {
                const notesWindow = systemState.openWindows.find(w => w.id === 'notes');
                if (notesWindow) {
                    const textArea = notesWindow.element.querySelector('#note-content');
                    if (textArea) {
                        textArea.value += text; textArea.dispatchEvent(new Event('input'));
                        this.logActivity(`Mielina: Digitou texto no Bloco de Notas: "${text.substring(0, 50)}..."`); return `Texto digitado no Bloco de Notas.`;
                    } else { return `Área de texto do Bloco de Notas não encontrada.`; }
                } else { return `Aplicativo Bloco de Notas não está aberto.`; }
            },
            saveNotepad: async function() {
                const notesWindow = systemState.openWindows.find(w => w.id === 'notes');
                if (notesWindow) {
                    const saveBtn = notesWindow.element.querySelector('#save-note');
                    if (saveBtn) { saveBtn.click(); this.logActivity(`Mielina: Acionou o salvamento no Bloco de Notas.`); return `Comando de salvar acionado no Bloco de Notas.`; }
                    else { return `Botão de salvar do Bloco de Notas não encontrado.`; }
                } else { return `Aplicativo Bloco de Notas não está aberto.`; }
            },
            saveCode: function() {
                // Em um ambiente de navegador, JavaScript não pode salvar arquivos diretamente no sistema de arquivos do usuário
                // ou modificar o arquivo HTML original no servidor por razões de segurança.
                // Esta função simula o "salvamento" do código atual em uma variável ou log.
                const currentCode = this.getSystemCode();
                console.log("Mielina: Código-fonte atual 'salvo' (simulado).");
                this.logActivity("Mielina: Código-fonte atual 'salvo' (simulado).");
                // Você pode armazenar isso em localStorage para persistência simulada
                localStorage.setItem('axon-system-code-snapshot', currentCode);
                return "Código-fonte atual do sistema 'salvo' com sucesso (simulado).";
            },
            debug: function(message) {
                console.log(`[Mielina Debug] ${message}`);
                this.logActivity(`Mielina Debug: ${message}`);
                return `Mensagem de depuração enviada para o console: "${message}"`;
            },
            checkChanges: function(oldCode) {
                const currentCode = this.getSystemCode();
                if (oldCode === currentCode) {
                    this.logActivity("Mielina: Verificou que não houve alterações no código.");
                    return "Nenhuma alteração detectada no código.";
                } else {
                    this.logActivity("Mielina: Verificou que houve alterações no código.");
                    return "Alterações detectadas no código.";
                }
            },
            closeWindow: function(windowId) { closeWindow(windowId); this.logActivity(`Mielina: Fechou a janela com ID "${windowId}"`); },
            minimizeWindow: function(windowId) { minimizeWindow(windowId); this.logActivity(`Mielina: Minimizou a janela com ID "${windowId}"`); },
            toggleMaximizeWindow: function(windowId) { toggleMaximizeWindow(windowId); this.logActivity(`Mielina: Maximizou/Restaurou a janela com ID "${windowId}"`); },
            createFileItem: function(directoryId, type, name, content = '', src = '') {
                const result = createFileItem(directoryId, type, name, content, src);
                if (result) { this.logActivity(`Mielina: Criou item "${name}" (tipo: ${type}) em "${directoryId}"`); }
                return result;
            },
            deleteFileItem: function(itemId, parentDirId, save = true) { deleteFileItem(itemId, parentDirId, save); this.logActivity(`Mielina: Excluiu item com ID "${itemId}" de "${parentDirId}"`); },
            restoreTrashItem: function(itemId) { restoreTrashItem(itemId); this.logActivity(`Mielina: Restaurou item com ID "${itemId}" da lixeira`); },
            deletePermanentTrashItem: function(itemId) { deletePermanentTrashItem(itemId); this.logActivity(`Mielina: Excluiu permanentemente item com ID "${itemId}" da lixeira`); },
            renameFileItem: function(itemId, parentDirId, newName) { updateFileItemName(itemId, parentDirId, newName); this.logActivity(`Mielina: Renomeou item com ID "${itemId}" para "${newName}"`); },
            copyItem: async function(itemToCopy, targetDirectoryId, isCut = false) { await copyItem(itemToCopy, targetDirectoryId, isCut); this.logActivity(`Mielina: Copiou/Moveu item "${itemToCopy.name}" para "${targetDirectoryId}" (corte: ${isCut})`); }
        };

        window.AxonAPI = AxonAPI;
        window.addEventListener('load', initSystem);
        document.addEventListener('click', (e) => {
            if (!contextMenu.contains(e.target) && !e.target.closest('.desktop-icon') && !e.target.closest('.file-item')) {
                hideContextMenu();
            }
        });
    </script>
</body>
</html>
